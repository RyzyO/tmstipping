<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Profile - The Great Spring Tip Off</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#fbbf24">

  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateEmail, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyCrgNrA4n62hg1U3ujZMRCOYcbLcwT77ZA",
      authDomain: "tmstipping.firebaseapp.com",
      projectId: "tmstipping",
      storageBucket: "tmstipping.appspot.com",
      messagingSenderId: "401677933527",
      appId: "1:401677933527:web:2312ad4ef69aef6551c992",
      measurementId: "G-GXLRCHV687"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let selectedSilk = 1;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        try {
          await loadUserProfile();
          await loadUserStats();
        } catch (error) {
          console.error('Error loading profile:', error);
        }
      } else {
        window.location.href = 'logindark';
      }
    });

    async function loadUserProfile() {
      if (!currentUser) return;
      
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          document.getElementById('userName').textContent = userData.teamName || currentUser.email;
          selectedSilk = userData.silk || 1;
          updateSilkSelection(selectedSilk);
          updateProfileAvatar(selectedSilk);
        } else {
          document.getElementById('userName').textContent = currentUser.email;
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
        document.getElementById('userName').textContent = currentUser.email;
      }
    }

    async function loadUserStats() {
      if (!currentUser) return;
      
      try {
        // Get total tips
        const tipsQuery = query(collection(db, 'tips'), where('userId', '==', currentUser.uid));
        const tipsSnap = await getDocs(tipsQuery);
        document.getElementById('totalTips').textContent = tipsSnap.size;

        // Get leaderboard position and points
        const leaderboardQuery = query(collection(db, 'leaderboard'), orderBy('points', 'desc'));
        const leaderboardSnap = await getDocs(leaderboardQuery);
        let rank = 0;
        let points = 0;
        
        leaderboardSnap.forEach((docSnap, index) => {
          if (docSnap.data().userId === currentUser.uid) {
            rank = index + 1;
            points = docSnap.data().points || 0;
          }
        });

        document.getElementById('currentRank').textContent = rank > 0 ? rank : '-';
        document.getElementById('totalPoints').textContent = points.toFixed(2);
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    function updateSilkSelection(silkNumber) {
      document.querySelectorAll('.silk-option').forEach(el => {
        el.classList.remove('selected');
      });
      const selectedEl = document.querySelector(`[data-silk="${silkNumber}"]`);
      if (selectedEl) {
        selectedEl.classList.add('selected');
      }
    }

    function updateProfileAvatar(silkNumber) {
      const avatarEl = document.getElementById('profileAvatar');
      if (!avatarEl) return;
      
      if (silkNumber) {
        avatarEl.innerHTML = `<img src="static/silks/${silkNumber}.png" alt="Silk ${silkNumber}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<i data-feather=\\'user\\' class=\\'h-8 w-8 text-yellow-400\\'></i>'; feather.replace();">`;
      } else {
        avatarEl.innerHTML = `<i data-feather="user" class="h-8 w-8 text-yellow-400"></i>`;
      }
      feather.replace();
    }

    window.selectSilk = async function(silkNumber) {
      if (!currentUser) return;
      
      selectedSilk = silkNumber;
      updateSilkSelection(silkNumber);
      updateProfileAvatar(silkNumber);
      
      // Save to Firestore
      try {
        await setDoc(doc(db, 'users', currentUser.uid), {
          silk: silkNumber
        }, { merge: true });
        
        // Show success feedback
        const successMsg = document.getElementById('successMessage');
        successMsg.classList.remove('hidden');
        setTimeout(() => {
          successMsg.classList.add('hidden');
        }, 2000);
      } catch (error) {
        console.error('Error saving silk:', error);
        alert('Failed to save silk selection');
      }
    };

    window.handleSignOut = async function() {
      try {
        await signOut(auth);
        window.location.href = 'logindark';
      } catch (error) {
        console.error('Sign out error:', error);
      }
    };

    window.handleChangeEmail = async function() {
      if (!currentUser) return;
      
      const currentPasswordInput = document.getElementById('emailCurrentPassword');
      const newEmailInput = document.getElementById('newEmail');
      const currentPasswordValue = currentPasswordInput.value.trim();
      const newEmailValue = newEmailInput.value.trim();
      
      if (!currentPasswordValue) {
        alert('Please enter your current password');
        return;
      }
      
      if (!newEmailValue) {
        alert('Please enter a new email address');
        return;
      }
      
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmailValue)) {
        alert('Please enter a valid email address');
        return;
      }
      
      try {
        // Reauthenticate user
        const credential = EmailAuthProvider.credential(
          currentUser.email,
          currentPasswordValue
        );
        await reauthenticateWithCredential(currentUser, credential);
        
        // Update email
        await updateEmail(currentUser, newEmailValue);
        
        // Show success message
        alert('Email updated successfully! You may need to verify your new email.');
        
        // Clear inputs
        currentPasswordInput.value = '';
        newEmailInput.value = '';
        
        // Reload profile to show new email
        await loadUserProfile();
      } catch (error) {
        console.error('Error updating email:', error);
        if (error.code === 'auth/wrong-password') {
          alert('Incorrect password. Please try again.');
        } else if (error.code === 'auth/email-already-in-use') {
          alert('This email is already in use by another account.');
        } else if (error.code === 'auth/requires-recent-login') {
          alert('For security reasons, please sign out and sign in again before changing your email.');
        } else {
          alert('Failed to update email: ' + error.message);
        }
      }
    };

    window.handleChangePassword = async function() {
      if (!currentUser) return;
      
      const currentPasswordInput = document.getElementById('currentPassword');
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      
      const currentPasswordValue = currentPasswordInput.value.trim();
      const newPasswordValue = newPasswordInput.value.trim();
      const confirmPasswordValue = confirmPasswordInput.value.trim();
      
      if (!currentPasswordValue) {
        alert('Please enter your current password');
        return;
      }
      
      if (!newPasswordValue) {
        alert('Please enter a new password');
        return;
      }
      
      if (newPasswordValue.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
      }
      
      if (newPasswordValue !== confirmPasswordValue) {
        alert('Passwords do not match');
        return;
      }
      
      if (currentPasswordValue === newPasswordValue) {
        alert('New password must be different from current password');
        return;
      }
      
      try {
        // Reauthenticate user
        const credential = EmailAuthProvider.credential(
          currentUser.email,
          currentPasswordValue
        );
        await reauthenticateWithCredential(currentUser, credential);
        
        // Update password
        await updatePassword(currentUser, newPasswordValue);
        
        // Show success message
        alert('Password updated successfully!');
        
        // Clear inputs
        currentPasswordInput.value = '';
        newPasswordInput.value = '';
        confirmPasswordInput.value = '';
      } catch (error) {
        console.error('Error updating password:', error);
        if (error.code === 'auth/wrong-password') {
          alert('Incorrect current password. Please try again.');
        } else if (error.code === 'auth/weak-password') {
          alert('New password is too weak. Please choose a stronger password.');
        } else if (error.code === 'auth/requires-recent-login') {
          alert('For security reasons, please sign out and sign in again before changing your password.');
        } else {
          alert('Failed to update password: ' + error.message);
        }
      }
    };

    // Initialize silk grid when page loads
    document.addEventListener('DOMContentLoaded', () => {
      const silkGrid = document.getElementById('silkGrid');
      if (silkGrid) {
        for (let i = 1; i <= 32; i++) {
          const silkOption = document.createElement('div');
          silkOption.className = 'silk-option cursor-pointer rounded-xl p-4 border-2 border-gray-700 hover:border-yellow-400 transition-all duration-200';
          silkOption.setAttribute('data-silk', i);
          silkOption.onclick = () => window.selectSilk(i);
          silkOption.innerHTML = `
            <img src="static/silks/${i}.png" alt="Silk ${i}" class="w-full h-auto rounded-lg" onerror="this.src='images/logo.png'">
            <p class="text-center text-gray-400 text-sm mt-2">Silk ${i}</p>
          `;
          silkGrid.appendChild(silkOption);
        }
      }
    });
  </script>

  <style>
    .gradient-text {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }
    .card {
      background: linear-gradient(145deg, rgba(31, 41, 55, 0.9), rgba(17, 24, 39, 0.9));
      border: 1px solid rgba(75, 85, 99, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .silk-option.selected {
      border-color: #fbbf24;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">
  <!-- Navigation -->
  <nav class="sticky top-0 z-50 glass-effect">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <img src="images/logo.png" alt="Logo" class="h-8 w-8 mr-2" style="object-fit: contain;" />
          <h1 class="text-xl font-bold gradient-text">The Great Spring Tip Off</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button class="md:hidden" onclick="toggleMenu()">
            <i data-feather="menu" class="h-6 w-6 text-gray-200"></i>
          </button>
          <div class="hidden md:flex space-x-6">
            <a href="dark.html" class="text-gray-300 hover:text-yellow-400 transition">Home</a>
            <a href="tipdark.html" class="text-gray-300 hover:text-yellow-400 transition">Tip Now</a>
            <a href="leaderboarddark.html" class="text-gray-300 hover:text-yellow-400 transition">Leaderboard</a>
            <a href="resultsdark.html" class="text-gray-300 hover:text-yellow-400 transition">Results</a>
            <a href="podcastdark.html" class="text-gray-300 hover:text-yellow-400 transition">Podcast</a>
            <a href="faqdark.html" class="text-gray-300 hover:text-yellow-400 transition">FAQ</a>
            <a href="prizesdark.html" class="text-gray-300 hover:text-yellow-400 transition">Prizes</a>
            <a href="profiledark.html" class="text-yellow-400 font-semibold">Profile</a>
          </div>
        </div>
      </div>
    </div>
    <div id="mobileMenu" class="hidden md:hidden glass-effect px-4 py-2 space-y-2">
      <a href="dark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Home</a>
      <a href="tipdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Tip Now</a>
      <a href="leaderboarddark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Leaderboard</a>
      <a href="resultsdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Results</a>
      <a href="podcastdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Podcast</a>
      <a href="faqdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">FAQ</a>
      <a href="prizesdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Prizes</a>
      <a href="profiledark.html" class="block py-2 text-yellow-400 font-semibold">Profile</a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
    <!-- Success Message -->
    <div id="successMessage" class="hidden fixed top-24 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
      Silk saved successfully!
    </div>

    <!-- Header Section -->
    <section class="mb-10" data-aos="fade-up">
      <div class="card rounded-2xl shadow-2xl p-8 md:p-10 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-yellow-600/10 to-transparent rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-amber-600/10 to-transparent rounded-full blur-3xl"></div>
        <div class="relative z-10">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
              <div id="profileAvatar" class="w-16 h-16 bg-gradient-to-br from-yellow-500/20 to-amber-600/20 rounded-full flex items-center justify-center border border-yellow-500/30 overflow-hidden">
                <i data-feather="user" class="h-8 w-8 text-yellow-400"></i>
              </div>
              <div>
                <h2 class="text-2xl md:text-3xl font-bold gradient-text" id="userName">Loading...</h2>
                <p class="text-gray-400">Your Profile</p>
              </div>
            </div>
            <button onclick="handleSignOut()" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 text-red-400 rounded-lg transition-all duration-200 flex items-center gap-2">
              <i data-feather="log-out" class="h-4 w-4"></i>
              Sign Out
            </button>
          </div>

          <!-- Stats Grid -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
              <p class="text-gray-400 text-sm mb-1">Total Tips</p>
              <p class="text-3xl font-bold text-white" id="totalTips">0</p>
            </div>
            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
              <p class="text-gray-400 text-sm mb-1">Current Rank</p>
              <p class="text-3xl font-bold gradient-text" id="currentRank">-</p>
            </div>
            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
              <p class="text-gray-400 text-sm mb-1">Total Points</p>
              <p class="text-3xl font-bold text-yellow-400" id="totalPoints">0.00</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Account Settings Section -->
    <section data-aos="fade-up" class="mb-8">
      <div class="card rounded-2xl shadow-2xl p-8 md:p-10">
        <div class="flex items-center gap-3 mb-6">
          <i data-feather="settings" class="h-8 w-8 text-yellow-400"></i>
          <h3 class="text-2xl font-bold gradient-text">Account Settings</h3>
        </div>

        <!-- Change Email -->
        <div class="mb-6 p-6 bg-gray-800/50 rounded-xl border border-gray-700">
          <h4 class="text-lg font-semibold text-gray-200 mb-4 flex items-center gap-2">
            <i data-feather="mail" class="h-5 w-5 text-yellow-400"></i>
            Change Email
          </h4>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-400 mb-2">Current Password</label>
              <input type="password" id="emailCurrentPassword" placeholder="Enter current password to verify" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-2">New Email</label>
              <input type="email" id="newEmail" placeholder="Enter new email" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition">
            </div>
            <button onclick="handleChangeEmail()" class="px-6 py-2 bg-yellow-500/20 hover:bg-yellow-500/30 border border-yellow-500/50 text-yellow-400 rounded-lg transition-all duration-200 flex items-center gap-2">
              <i data-feather="check" class="h-4 w-4"></i>
              Update Email
            </button>
          </div>
        </div>

        <!-- Change Password -->
        <div class="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
          <h4 class="text-lg font-semibold text-gray-200 mb-4 flex items-center gap-2">
            <i data-feather="lock" class="h-5 w-5 text-yellow-400"></i>
            Change Password
          </h4>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-400 mb-2">Current Password</label>
              <input type="password" id="currentPassword" placeholder="Enter current password" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-2">New Password</label>
              <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-2">Confirm New Password</label>
              <input type="password" id="confirmPassword" placeholder="Confirm new password" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-yellow-400 focus:outline-none transition">
            </div>
            <button onclick="handleChangePassword()" class="px-6 py-2 bg-yellow-500/20 hover:bg-yellow-500/30 border border-yellow-500/50 text-yellow-400 rounded-lg transition-all duration-200 flex items-center gap-2">
              <i data-feather="check" class="h-4 w-4"></i>
              Update Password
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Silk Selection Section -->
    <section data-aos="fade-up" class="mb-8">
      <div class="card rounded-2xl shadow-2xl p-8 md:p-10">
        <div class="flex items-center gap-3 mb-6">
          <i data-feather="image" class="h-8 w-8 text-yellow-400"></i>
          <h3 class="text-2xl font-bold gradient-text">Choose Your Racing Silk</h3>
        </div>
        <p class="text-gray-400 mb-6">Select a silk design to represent you on the leaderboard</p>
        
        <div id="silkGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
          <!-- Silks will be dynamically added here -->
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-950 border-t border-gray-800 text-gray-400 py-10 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex flex-col items-center md:items-start">
          <div class="flex items-center mb-2">
            <img src="images/logo.png" alt="Logo" class="h-6 w-6 mr-2" style="object-fit: contain;" />
            <span class="font-semibold text-gray-300">The Mock Sports</span>
          </div>
          <p class="text-sm text-gray-500">&copy; 2026 All rights reserved.</p>
        </div>
        <div class="flex space-x-6">
          <a href="https://x.com/themocksports" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition-colors duration-200" aria-label="Follow us on X">
            <i data-feather="twitter" class="h-5 w-5"></i>
          </a>
          <a href="https://facebook.com/TheMockSports" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition-colors duration-200" aria-label="Follow us on Facebook">
            <i data-feather="facebook" class="h-5 w-5"></i>
          </a>
          <a href="https://instagram.com/themocksports" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition-colors duration-200" aria-label="Follow us on Instagram">
            <i data-feather="instagram" class="h-5 w-5"></i>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    function toggleMenu() {
      document.getElementById('mobileMenu').classList.toggle('hidden');
    }
    window.toggleMenu = toggleMenu;

    AOS.init({ duration: 800, once: true, offset: 50 });
    feather.replace();
  </script>
</body>
</html>
