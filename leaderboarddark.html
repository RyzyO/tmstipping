<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaderboard - The Great Spring Tip Off</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    .gradient-text {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(24,24,24,0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 215, 0, 0.1);
    }
    .table-row { transition: all .2s ease; cursor:pointer; }
    .table-row:hover { background: rgba(255,215,0,0.1); }
    .modal { background: rgba(0,0,0,0.85); }
    .search-input::placeholder { color: rgba(255, 193, 7, 0.6); }
    .medal-gold { color: #fbbf24; }
    .medal-silver { color: #c0cfd9; }
    .medal-bronze { color: #cd7f32; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">

  <!-- Navigation -->
  <nav class="sticky top-0 z-50 glass-effect">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <img src="images/logo.png" alt="Logo" class="h-8 w-8 mr-2" style="object-fit:contain;">
          <h1 class="text-xl font-bold gradient-text">The Great Spring Tip Off</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button class="md:hidden" onclick="toggleMenu()">
            <i data-feather="menu" class="h-6 w-6 text-gray-200"></i>
          </button>
          <div class="hidden md:flex space-x-6">
            <a href="dark.html" class="text-gray-300 hover:text-yellow-400 transition">Home</a>
            <a href="tipdark.html" class="text-gray-300 hover:text-yellow-400 transition">Tip Now</a>
            <a href="leaderboarddark.html" class="text-gray-300 hover:text-yellow-400 transition">Leaderboard</a>
            <a href="faq.html" class="text-gray-300 hover:text-yellow-400 transition">FAQ</a>
            <a href="prizesdark.html" class="text-gray-300 hover:text-yellow-400 transition">Prizes</a>
          </div>
        </div>
      </div>
    </div>
    <div id="mobileMenu" class="hidden md:hidden glass-effect px-4 py-2 space-y-2">
      <a href="dark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Home</a>
      <a href="tipdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Tip Now</a>
      <a href="leaderboarddark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Leaderboard</a>
      <a href="faq.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">FAQ</a>
      <a href="prizesdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Prizes</a>
    </div>
  </nav>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex-grow">
    <h2 class="text-3xl md:text-4xl font-bold mb-6 gradient-text text-center">Leaderboard</h2>

    <!-- Search -->
    <div class="max-w-md mx-auto mb-8">
      <input id="search-input" type="text" placeholder="Search team..."
        class="search-input w-full px-4 py-3 rounded-lg bg-gray-800 text-gray-100 border border-yellow-500 focus:ring-2 focus:ring-yellow-400 focus:border-transparent outline-none transition">
    </div>

    <!-- Leaderboard -->
    <div class="glass-effect rounded-lg shadow-lg overflow-hidden">
      <!-- Desktop Table -->
      <table class="w-full hidden md:table divide-y divide-gray-700">
        <thead class="bg-gray-800">
          <tr>
            <th class="px-3 py-2 text-left text-sm font-semibold text-yellow-400">Rank</th>
            <th class="px-3 py-2 text-left text-sm font-semibold text-yellow-400">Team</th>
            <th class="px-3 py-2 text-left text-sm font-semibold text-yellow-400">Points</th>
            <th class="px-3 py-2 text-left text-sm font-semibold text-yellow-400">Jokers</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body" class="divide-y divide-gray-700"></tbody>
      </table>

      <!-- Mobile Card View -->
      <div id="leaderboard-mobile" class="space-y-3 p-3 md:hidden"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-950 text-gray-400 py-8 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
      <p class="text-sm">&copy; 2026 The Mock Sports. All rights reserved.</p>
      <div class="flex space-x-6">
        <a href="https://twitter.com" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition" aria-label="Twitter"><i data-feather="twitter"></i></a>
        <a href="https://facebook.com" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition" aria-label="Facebook"><i data-feather="facebook"></i></a>
        <a href="https://instagram.com" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition" aria-label="Instagram"><i data-feather="instagram"></i></a>
      </div>
    </div>
  </footer>

  <!-- Modal -->
  <div id="user-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal" role="dialog" aria-modal="true" aria-labelledby="modal-user-name">
    <div class="bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-6 relative overflow-y-auto max-h-[90vh]">
      <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-yellow-400 transition text-2xl" aria-label="Close modal">&times;</button>
      <h3 id="modal-user-name" class="text-2xl font-bold mb-6 gradient-text"></h3>
      <div id="modal-user-results" class="space-y-4"></div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-yellow-500 border-t-transparent mx-auto"></div>
      <p class="mt-4 text-yellow-400 font-semibold">Loading Leaderboardâ€¦</p>
    </div>
  </div>

  <script>
    function toggleMenu() {
      const menu = document.getElementById("mobileMenu");
      menu.classList.toggle("hidden");
    }
    window.toggleMenu = toggleMenu;
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const { DateTime } = luxon;

    // Load config from separate file to avoid exposing credentials
    let firebaseConfig = null;
    try {
      const response = await fetch('firebase-config.js');
      const text = await response.text();
      eval(text);
    } catch (e) {
      console.error('Failed to load Firebase config:', e);
    }

    if (!firebaseConfig) {
      // Fallback (but should use firebase-config.js)
      firebaseConfig = {
        apiKey: "AIzaSyCrgNrA4n62hg1U3ujZMRCOYcbLcwT77ZA",
        authDomain: "tmstipping.firebaseapp.com",
        projectId: "tmstipping",
        storageBucket: "tmstipping.appspot.com",
        messagingSenderId: "401677933527",
        appId: "1:401677933527:web:2312ad4ef69aef6551c992",
        measurementId: "G-GXLRCHV687"
      };
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let cachedLeaderboard = [];
    let cachedRaces = {};
    let cachedResults = {};
    let cachedTips = {};

    function showLoading() {
      document.getElementById("loading-overlay").classList.remove("hidden");
    }
    
    function hideLoading() {
      document.getElementById("loading-overlay").classList.add("hidden");
    }
    
    function closeModal() {
      document.getElementById("user-modal").classList.add("hidden");
    }
    
    window.closeModal = closeModal;

    // Close modal on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Close modal when clicking outside
    document.getElementById("user-modal").addEventListener('click', (e) => {
      if (e.target.id === 'user-modal') closeModal();
    });

    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      await loadLeaderboard();
    });

    async function loadLeaderboard() {
      showLoading();
      try {
        const leaderboardSnap = await getDocs(collection(db, "leaderboard"));
        const usersSnap = await getDocs(collection(db, "users"));

        const jokersMap = {};
        usersSnap.forEach(d => {
          jokersMap[d.id] = d.data().joker ?? 0;
        });

        cachedLeaderboard = [];
        leaderboardSnap.forEach(docSnap => {
          const d = docSnap.data();
          let pts = parseFloat(d.points) || 0;
          cachedLeaderboard.push({
            userId: docSnap.id,
            teamName: d.teamName,
            points: pts,
            jokers: jokersMap[docSnap.id] || 0
          });
        });

        cachedLeaderboard.sort((a, b) => b.points - a.points);

        const tbody = document.getElementById("leaderboard-body");
        const mobile = document.getElementById("leaderboard-mobile");
        tbody.innerHTML = "";
        mobile.innerHTML = "";

        if (cachedLeaderboard.length === 0) {
          const emptyMsg = document.createElement("tr");
          emptyMsg.innerHTML = '<td colspan="4" class="px-4 py-8 text-center text-gray-400">No leaderboard data available yet.</td>';
          tbody.appendChild(emptyMsg);
          return;
        }

        cachedLeaderboard.forEach((entry, i) => {
          // Desktop row
          const tr = document.createElement("tr");
          tr.className = "table-row";
          
          let rankDisplay = `${i + 1}`;
          if (i === 0) rankDisplay = 'ðŸ¥‡ ' + rankDisplay;
          else if (i === 1) rankDisplay = 'ðŸ¥ˆ ' + rankDisplay;
          else if (i === 2) rankDisplay = 'ðŸ¥‰ ' + rankDisplay;
          
          tr.innerHTML = `
            <td class="px-3 py-3">${rankDisplay}</td>
            <td class="px-3 py-3 font-medium">${entry.teamName || entry.userId}</td>
            <td class="px-3 py-3 text-yellow-400 font-bold">${entry.points.toFixed(2)}</td>
            <td class="px-3 py-3">${entry.jokers}</td>
          `;
          tr.onclick = () => loadUserResults(entry);
          tr.setAttribute('role', 'button');
          tr.setAttribute('tabindex', '0');
          tr.setAttribute('aria-label', `${entry.teamName || entry.userId}, ${entry.points} points, click to view details`);
          tr.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') loadUserResults(entry);
          });
          tbody.appendChild(tr);

          // Mobile card
          const card = document.createElement("div");
          card.className = "glass-effect p-4 rounded-lg shadow cursor-pointer hover:bg-yellow-400/5 transition";
          card.innerHTML = `
            <div class="flex justify-between items-center mb-3">
              <span class="text-yellow-400 font-bold text-lg">#${i + 1}</span>
              <span class="text-gray-300 font-semibold">${entry.teamName || entry.userId}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-400">
              <span>Points: <span class="text-yellow-400 font-bold">${entry.points.toFixed(2)}</span></span>
              <span>Jokers: <span class="text-yellow-400 font-bold">${entry.jokers}</span></span>
            </div>
          `;
          card.onclick = () => loadUserResults(entry);
          card.setAttribute('role', 'button');
          card.setAttribute('tabindex', '0');
          card.setAttribute('aria-label', `${entry.teamName || entry.userId}, ${entry.points} points, click to view details`);
          card.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') loadUserResults(entry);
          });
          mobile.appendChild(card);
        });

        // Search functionality
        document.getElementById("search-input").oninput = e => {
          const val = e.target.value.toLowerCase();
          let visibleCount = 0;
          
          Array.from(tbody.children).forEach(row => {
            const teamName = row.children[1]?.textContent.toLowerCase();
            const isVisible = !val || teamName?.includes(val);
            row.style.display = isVisible ? "" : "none";
            if (isVisible) visibleCount++;
          });
          
          Array.from(mobile.children).forEach(card => {
            const isVisible = !val || card.textContent.toLowerCase().includes(val);
            card.style.display = isVisible ? "" : "none";
          });

          // Show "no results" message if needed
          if (visibleCount === 0 && val) {
            const noResults = document.createElement("tr");
            noResults.innerHTML = '<td colspan="4" class="px-4 py-8 text-center text-gray-400">No teams found matching your search.</td>';
            tbody.appendChild(noResults);
          }
        };

        hideLoading();
      } catch (error) {
        console.error('Error loading leaderboard:', error);
        hideLoading();
        alert('Failed to load leaderboard. Please refresh the page.');
      }
    }

    async function loadUserResults(entry) {
      showLoading();
      try {
        // Use cached data if available, otherwise fetch
        if (Object.keys(cachedRaces).length === 0) {
          const tipsSnap = await getDocs(collection(db, "tips"));
          const resultsSnap = await getDocs(collection(db, "results"));
          const racesSnap = await getDocs(collection(db, "races"));

          racesSnap.forEach(d => cachedRaces[d.id] = d.data());
          resultsSnap.forEach(d => cachedResults[d.id] = d.data());
          tipsSnap.forEach(d => {
            const t = d.data();
            if (t.userId === entry.userId) cachedTips[t.raceId] = t;
          });
        }

        const userTips = {};
        const tipsSnap = await getDocs(collection(db, "tips"));
        tipsSnap.forEach(d => {
          const t = d.data();
          if (t.userId === entry.userId) userTips[t.raceId] = t;
        });

        const container = document.getElementById("modal-user-results");
        container.innerHTML = "";

        let resultCount = 0;
        for (const [raceId, race] of Object.entries(cachedRaces)) {
          if (!cachedResults[raceId]) continue;
          const res = cachedResults[raceId];
          const tip = userTips[raceId];
          if (!tip) continue;

          resultCount++;

          const winOnly = parseFloat(res.points) || 0;
          const placeFromWin = parseFloat(res.place1Points) || 0;
          const winnerPoints = winOnly + placeFromWin;
          const place2Points = parseFloat(res.place2Points) || 0;
          const place3Points = parseFloat(res.place3Points) || 0;

          const winnerName = race.horses?.[res.winningHorseId]?.name || "â€”";
          const place1Name = race.horses?.[res.place1HorseId]?.name || "â€”";
          const place2Name = race.horses?.[res.place2HorseId]?.name || "â€”";
          const place3Name = race.horses?.[res.place3HorseId]?.name || "â€”";
          const dateStr = race.date ? DateTime.fromISO(race.date).toFormat("dd/LL/yyyy") : "â€”";

          let pts = 0, correct = false;
          if (tip.horseId === res.winningHorseId) {
            pts = winnerPoints;
            correct = true;
          } else if (tip.horseId === res.place1HorseId) {
            pts = placeFromWin;
            correct = true;
          } else if (tip.horseId === res.place2HorseId) {
            pts = place2Points;
            correct = true;
          } else if (tip.horseId === res.place3HorseId) {
            pts = place3Points;
            correct = true;
          }
          if (correct && tip.joker) pts *= 2;

          const div = document.createElement("div");
          div.className = `p-4 rounded-lg border ${correct ? "border-green-500/30 bg-green-900/20" : "border-red-500/30 bg-red-900/20"}`;
          div.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <h4 class="text-lg font-bold text-white">${race.name}</h4>
              <span class="text-xs text-gray-400">${dateStr}</span>
            </div>
            <div class="space-y-2 text-sm">
              <p>Your tip: <strong class="text-yellow-400">${race.horses?.[tip.horseId]?.name || "â€”"}</strong>
                ${tip.joker ? "<span class='ml-2 bg-purple-600/80 text-white px-2 py-0.5 rounded text-xs inline-block'>JOKER</span>" : ""}</p>
              <p>1st: <strong>${winnerName}</strong> <span class="text-green-400">${winnerPoints ? `+${winnerPoints.toFixed(2)}` : "â€”"}</span></p>
              <p>2nd: <strong>${place1Name}</strong> <span class="text-green-400">${placeFromWin ? `+${placeFromWin.toFixed(2)}` : "â€”"}</span></p>
              <p>3rd: <strong>${place2Name}</strong> <span class="text-green-400">${place2Points ? `+${place2Points.toFixed(2)}` : "â€”"}</span></p>
              <p>4th: <strong>${place3Name}</strong> <span class="text-green-400">${place3Points ? `+${place3Points.toFixed(2)}` : "â€”"}</span></p>
            </div>
            <div class="mt-3 pt-2 border-t border-gray-700">
              ${correct ? `<p class="text-green-400 font-bold">âœ“ +${pts.toFixed(2)} pts</p>` : `<p class="text-red-400 font-semibold">âœ— No points</p>`}
            </div>
          `;
          container.appendChild(div);
        }

        if (resultCount === 0) {
          container.innerHTML = '<div class="p-4 text-center text-gray-400">No results to display yet.</div>';
        }

        document.getElementById("modal-user-name").textContent = entry.teamName || entry.userId;
        document.getElementById("user-modal").classList.remove("hidden");
        hideLoading();
      } catch (error) {
        console.error('Error loading user results:', error);
        hideLoading();
        alert('Failed to load team details. Please try again.');
      }
    }

    AOS.init({duration: 1000, once: true});
    feather.replace();
  </script>
</body>
</html>
