<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaderboard - The Great Spring Tip Off</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    .gradient-text {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(24,24,24,0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 215, 0, 0.1);
    }
    .table-row { transition: all .2s ease; cursor:pointer; }
    .table-row:hover { background: rgba(255,215,0,0.1); }
    .modal { background: rgba(0,0,0,0.85); }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">

  <!-- Navigation -->
  <nav class="sticky top-0 z-50 glass-effect">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <img src="logo.jfif" alt="Logo" class="h-8 w-8 mr-2 object-contain rounded"/>
          <h1 class="text-xl font-bold gradient-text">The Great Spring Tip Off</h1>
        </div>
        <div class="hidden md:flex space-x-6">
          <a href="dark.html" class="text-gray-300 hover:text-yellow-400">Home</a>
          <a href="tipdark.html" class="text-gray-300 hover:text-yellow-400">Tip Now</a>
          <a href="leaderboarddark.html" class="text-yellow-400 font-bold">Leaderboard</a>
          <a href="resultsdark.html" class="text-gray-300 hover:text-yellow-400">Results</a>
          <a href="faq.html" class="text-gray-300 hover:text-yellow-400">FAQ</a>
          <a href="prizes.html" class="text-gray-300 hover:text-yellow-400">Prizes</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex-grow">
    <h2 class="text-3xl md:text-4xl font-bold mb-6 gradient-text text-center">Leaderboard</h2>

    <!-- Search -->
    <div class="max-w-md mx-auto mb-6">
      <input id="search-input" type="text" placeholder="Search team..."
        class="w-full px-4 py-2 rounded-lg bg-gray-800 text-yellow-400 border border-yellow-500 focus:ring-2 focus:ring-yellow-400">
    </div>

    <!-- Table -->
    <div class="overflow-x-auto glass-effect rounded-lg shadow-lg">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-gray-800">
          <tr>
            <th class="px-4 py-3 text-left text-sm font-semibold text-yellow-400">Rank</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-yellow-400">Team</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-yellow-400">Points</th>
            <th class="px-4 py-3 text-left text-sm font-semibold text-yellow-400">Jokers</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body" class="divide-y divide-gray-700"></tbody>
      </table>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-950 text-gray-400 py-8 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
      <p class="text-sm">&copy; 2025 The Mock Sports. All rights reserved.</p>
      <div class="flex space-x-6">
        <a href="#" class="hover:text-yellow-400"><i data-feather="twitter"></i></a>
        <a href="#" class="hover:text-yellow-400"><i data-feather="facebook"></i></a>
        <a href="#" class="hover:text-yellow-400"><i data-feather="instagram"></i></a>
      </div>
    </div>
  </footer>

  <!-- Modal -->
  <div id="user-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal">
    <div class="bg-gray-800 rounded-xl shadow-lg max-w-2xl w-full p-6 relative overflow-y-auto max-h-[80vh]">
      <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-yellow-400">&times;</button>
      <h3 id="modal-user-name" class="text-2xl font-bold mb-4 gradient-text"></h3>
      <div id="modal-user-results" class="space-y-4"></div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-yellow-500 border-t-transparent mx-auto"></div>
      <p class="mt-4 text-yellow-400 font-semibold">Loading Leaderboardâ€¦</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const { DateTime } = luxon;

    const firebaseConfig = {
      apiKey: "AIzaSyCrgNrA4n62hg1U3ujZMRCOYcbLcwT77ZA",
      authDomain: "tmstipping.firebaseapp.com",
      projectId: "tmstipping",
      storageBucket: "tmstipping.appspot.com",
      messagingSenderId: "401677933527",
      appId: "1:401677933527:web:2312ad4ef69aef6551c992",
      measurementId: "G-GXLRCHV687"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function showLoading(){document.getElementById("loading-overlay").classList.remove("hidden");}
    function hideLoading(){document.getElementById("loading-overlay").classList.add("hidden");}
    function closeModal(){document.getElementById("user-modal").classList.add("hidden");}
    window.closeModal = closeModal;

    onAuthStateChanged(auth, async user=>{
      if(!user){window.location.href="login.html"; return;}
      await loadLeaderboard();
    });

    async function loadLeaderboard(){
      showLoading();
      const leaderboardSnap = await getDocs(collection(db,"leaderboard"));
      const usersSnap = await getDocs(collection(db,"users"));

      const jokersMap = {};
      usersSnap.forEach(d=>{ jokersMap[d.id] = d.data().joker ?? 0; });

      const leaderboard=[];
      leaderboardSnap.forEach(docSnap=>{
        const d = docSnap.data();
        let pts = parseFloat(d.points)||0;
        leaderboard.push({userId:docSnap.id, teamName:d.teamName, points:pts, jokers:jokersMap[docSnap.id]||0});
      });

      leaderboard.sort((a,b)=>b.points-a.points);

      const tbody=document.getElementById("leaderboard-body");
      tbody.innerHTML="";
      leaderboard.forEach((entry,i)=>{
        const tr=document.createElement("tr");
        tr.className="table-row";
        tr.innerHTML=`
          <td class="px-4 py-2">${i+1}</td>
          <td class="px-4 py-2">${entry.teamName||entry.userId}</td>
          <td class="px-4 py-2">${entry.points.toFixed(2)}</td>
          <td class="px-4 py-2">${entry.jokers}</td>
        `;
        tr.onclick=()=>loadUserResults(entry);
        tbody.appendChild(tr);
      });

      document.getElementById("search-input").oninput = e=>{
        const val=e.target.value.toLowerCase();
        Array.from(tbody.children).forEach(row=>{
          row.style.display=row.children[1].textContent.toLowerCase().includes(val)?"":"none";
        });
      };

      hideLoading();
    }

    async function loadUserResults(entry){
      showLoading();
      const tipsSnap = await getDocs(collection(db,"tips"));
      const resultsSnap = await getDocs(collection(db,"results"));
      const racesSnap = await getDocs(collection(db,"races"));

      const races={}; racesSnap.forEach(d=>races[d.id]=d.data());
      const results={}; resultsSnap.forEach(d=>results[d.id]=d.data());

      const userTips={};
      tipsSnap.forEach(d=>{const t=d.data(); if(t.userId===entry.userId) userTips[t.raceId]=t;});

      const container=document.getElementById("modal-user-results");
      container.innerHTML="";
      for(const [raceId,race] of Object.entries(races)){
        if(!results[raceId]) continue;
        const res=results[raceId];
        const tip=userTips[raceId];
        if(!tip) continue;

        // winner points = win odds + place odds
        const winOnly = parseFloat(res.points)||0;
        const placeFromWin = parseFloat(res.place1Points)||0;
        const winnerPoints = winOnly + placeFromWin;
        const place2Points = parseFloat(res.place2Points)||0;
        const place3Points = parseFloat(res.place3Points)||0;

        const winnerName=race.horses?.[res.winningHorseId]?.name||"";
        const place1Name=race.horses?.[res.place1HorseId]?.name||"";
        const place2Name=race.horses?.[res.place2HorseId]?.name||"";
        const place3Name=race.horses?.[res.place3HorseId]?.name||"";
        const dateStr=race.date?DateTime.fromISO(race.date).toFormat("dd/LL/yyyy"):"";

        let pts=0, correct=false;
        if(tip.horseId===res.winningHorseId){pts=winnerPoints; correct=true;}
        else if(tip.horseId===res.place1HorseId){pts=placeFromWin; correct=true;}
        else if(tip.horseId===res.place2HorseId){pts=place2Points; correct=true;}
        else if(tip.horseId===res.place3HorseId){pts=place3Points; correct=true;}
        if(correct && tip.joker) pts*=2;

        const div=document.createElement("div");
        div.className=`p-4 rounded-lg shadow ${correct?"bg-green-900/40":"bg-red-900/40"}`;
        div.innerHTML=`
          <h4 class="text-lg font-bold">${race.name} <span class="text-sm text-gray-400">(${dateStr})</span></h4>
          <p>Their tip: <strong>${race.horses?.[tip.horseId]?.name||"â€”"}</strong>
            ${tip.joker?"<span class='ml-2 bg-purple-600 text-white px-2 py-0.5 rounded text-xs'>JOKER</span>":""}</p>
          <p>1st: <strong>${winnerName}</strong> ${winnerPoints?`(+${winnerPoints.toFixed(2)})`:""}</p>
          <p>2nd: <strong>${place1Name}</strong> ${placeFromWin?`(+${placeFromWin.toFixed(2)})`:""}</p>
          <p>3rd: <strong>${place2Name}</strong> ${place2Points?`(+${place2Points.toFixed(2)})`:""}</p>
          <p>4th: <strong>${place3Name}</strong> ${place3Points?`(+${place3Points.toFixed(2)})`:""}</p>
          ${correct?`<p class="text-green-400 font-bold mt-2">+${pts.toFixed(2)} pts</p>`:`<p class="text-red-400 mt-2">No points</p>`}
        `;
        container.appendChild(div);
      }

      document.getElementById("modal-user-name").textContent=entry.teamName||entry.userId;
      document.getElementById("user-modal").classList.remove("hidden");
      hideLoading();
    }

    AOS.init({duration:1000,once:true}); feather.replace();
  </script>
</body>
</html>
