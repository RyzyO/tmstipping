<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Leaderboard - The Great Spring Tip Off</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#fbbf24">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    .gradient-text {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }
    .card {
      background: linear-gradient(145deg, rgba(31, 41, 55, 0.9), rgba(17, 24, 39, 0.9));
      border: 1px solid rgba(75, 85, 99, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
      border-color: rgba(251, 191, 36, 0.3);
    }
    .leaderboard-card {
      background: linear-gradient(145deg, rgba(31, 41, 55, 0.95), rgba(17, 24, 39, 0.95));
      border: 1px solid rgba(75, 85, 99, 0.4);
      transition: all 0.2s ease;
    }
    .leaderboard-card:hover {
      border-color: rgba(251, 191, 36, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 3rem;
      height: 3rem;
      border-radius: 0.75rem;
      font-weight: bold;
      font-size: 1.25rem;
    }
    .rank-1 {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(217, 119, 6, 0.2));
      border: 1px solid rgba(251, 191, 36, 0.4);
      color: #fbbf24;
    }
    .rank-2 {
      background: linear-gradient(135deg, rgba(192, 207, 217, 0.2), rgba(148, 163, 175, 0.2));
      border: 1px solid rgba(192, 207, 217, 0.4);
      color: #cbd5e1;
    }
    .rank-3 {
      background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(180, 83, 9, 0.2));
      border: 1px solid rgba(205, 127, 50, 0.4);
      color: #d97706;
    }
    .rank-other {
      background: rgba(75, 85, 99, 0.3);
      border: 1px solid rgba(75, 85, 99, 0.5);
      color: #d1d5db;
    }
    .table-row {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .table-row:hover {
      background: rgba(251, 191, 36, 0.05);
    }
    .modal { 
      background: rgba(0, 0, 0, 0.9);
    }
    .modal-content {
      background: linear-gradient(145deg, rgba(31, 41, 55, 0.95), rgba(17, 24, 39, 0.95));
      border: 1px solid rgba(75, 85, 99, 0.3);
    }
    .search-input {
      background: linear-gradient(145deg, rgba(31, 41, 55, 0.9), rgba(17, 24, 39, 0.9));
      border: 1px solid rgba(75, 85, 99, 0.4);
      transition: all 0.2s ease;
    }
    .search-input:focus {
      border-color: rgba(251, 191, 36, 0.5);
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }
    .search-input::placeholder { 
      color: rgba(156, 163, 175, 0.6);
    }
    .skeleton {
      background: linear-gradient(90deg, rgba(55, 65, 81, 0.3) 25%, rgba(75, 85, 99, 0.3) 50%, rgba(55, 65, 81, 0.3) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">

  <!-- Navigation -->
  <nav class="sticky top-0 z-50 glass-effect">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <img src="images/logo.png" alt="Logo" class="h-8 w-8 mr-2" style="object-fit:contain;">
          <h1 class="text-xl font-bold gradient-text">The Great Spring Tip Off</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button class="md:hidden" onclick="toggleMenu()">
            <i data-feather="menu" class="h-6 w-6 text-gray-200"></i>
          </button>
          <div class="hidden md:flex space-x-6">
            <a href="dark.html" class="text-gray-300 hover:text-yellow-400 transition">Home</a>
            <a href="tipdark.html" class="text-gray-300 hover:text-yellow-400 transition">Tip Now</a>
            <a href="leaderboarddark.html" class="text-gray-300 hover:text-yellow-400 transition">Leaderboard</a>
            <a href="resultsdark.html" class="text-gray-300 hover:text-yellow-400 transition">Results</a>
            <a href="podcastdark.html" class="text-gray-300 hover:text-yellow-400 transition">Podcast</a>
            <a href="faqdark.html" class="text-gray-300 hover:text-yellow-400 transition">FAQ</a>
            <a href="prizesdark.html" class="text-gray-300 hover:text-yellow-400 transition">Prizes</a>
            <a href="profiledark.html" class="text-gray-300 hover:text-yellow-400 transition">Profile</a>
          </div>
        </div>
      </div>
    </div>
    <div id="mobileMenu" class="hidden md:hidden glass-effect px-4 py-2 space-y-2">
      <a href="dark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Home</a>
      <a href="tipdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Tip Now</a>
      <a href="leaderboarddark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Leaderboard</a>
      <a href="resultsdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Results</a>
      <a href="podcastdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Podcast</a>
      <a href="faqdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">FAQ</a>
      <a href="prizesdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Prizes</a>
      <a href="profiledark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Profile</a>
    </div>
  </nav>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-10 flex-grow">
    <!-- Header Section -->
    <section class="mb-10" data-aos="fade-up">
      <div class="card rounded-2xl shadow-2xl p-8 md:p-10 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-yellow-600/10 to-transparent rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-amber-600/10 to-transparent rounded-full blur-3xl"></div>
        <div class="relative z-10">
          <h1 class="text-3xl md:text-4xl font-bold mb-2 gradient-text">Leaderboard</h1>
          <p class="text-gray-300">Check where you rank among all competitors</p>
        </div>
      </div>
    </section>

    <!-- Search Section -->
    <div class="max-w-2xl mx-auto mb-8">
      <input id="search-input" type="text" placeholder="Search team name..."
        class="search-input w-full px-5 py-3 rounded-xl text-gray-100 focus:outline-none transition-all">
    </div>

    <!-- Leaderboard Container -->
    <div class="card rounded-2xl shadow-2xl overflow-hidden" data-aos="fade-up">
      <!-- Desktop Table -->
      <table class="w-full hidden md:table divide-y divide-gray-700/50">
        <thead class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700/50">
          <tr>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Rank</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Team</th>
            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">Points</th>
            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-300">Jokers</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body" class="divide-y divide-gray-700/50"></tbody>
      </table>

      <!-- Mobile Card View -->
      <div id="leaderboard-mobile" class="space-y-2 md:hidden p-4"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-950 text-gray-400 py-8 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
      <p class="text-sm">&copy; 2026 The Mock Sports. All rights reserved.</p>
      <div class="flex space-x-6">
        <a href="https://twitter.com" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition" aria-label="Twitter"><i data-feather="twitter"></i></a>
        <a href="https://facebook.com" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition" aria-label="Facebook"><i data-feather="facebook"></i></a>
        <a href="https://instagram.com" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition" aria-label="Instagram"><i data-feather="instagram"></i></a>
      </div>
    </div>
  </footer>

  <!-- Modal -->
  <div id="user-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal" role="dialog" aria-modal="true" aria-labelledby="modal-user-name">
    <div class="modal-content rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-6 md:p-8 relative overflow-y-auto max-h-[90vh]">
      <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-yellow-400 transition text-2xl" aria-label="Close modal">&times;</button>
      <h3 id="modal-user-name" class="text-2xl md:text-3xl font-bold mb-8 gradient-text"></h3>
      <div id="modal-user-results" class="space-y-4"></div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-yellow-500 border-t-transparent mx-auto"></div>
      <p class="mt-4 text-yellow-400 font-semibold">Loading Leaderboard…</p>
    </div>
  </div>

  <script>
    function toggleMenu() {
      const menu = document.getElementById("mobileMenu");
      menu.classList.toggle("hidden");
    }
    window.toggleMenu = toggleMenu;
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const { DateTime } = luxon;

    // Load config from separate file to avoid exposing credentials
    let firebaseConfig = null;
    try {
      const response = await fetch('firebase-config.js');
      const text = await response.text();
      eval(text);
    } catch (e) {
      console.error('Failed to load Firebase config:', e);
    }

    if (!firebaseConfig) {
      // Fallback (but should use firebase-config.js)
      firebaseConfig = {
        apiKey: "AIzaSyCrgNrA4n62hg1U3ujZMRCOYcbLcwT77ZA",
        authDomain: "tmstipping.firebaseapp.com",
        projectId: "tmstipping",
        storageBucket: "tmstipping.appspot.com",
        messagingSenderId: "401677933527",
        appId: "1:401677933527:web:2312ad4ef69aef6551c992",
        measurementId: "G-GXLRCHV687"
      };
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let cachedLeaderboard = [];
    let cachedRaces = {};
    let cachedResults = {};
    let cachedTips = {};
    let searchTimeout;
    const LEADERBOARD_CACHE_KEY = "tmstipping:leaderboardCache";

    function showLoading() {
      document.getElementById("loading-overlay").classList.remove("hidden");
    }
    
    function hideLoading() {
      document.getElementById("loading-overlay").classList.add("hidden");
    }
    
    function closeModal() {
      document.getElementById("user-modal").classList.add("hidden");
    }
    
    window.closeModal = closeModal;

    // Close modal on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Close modal when clicking outside
    document.getElementById("user-modal").addEventListener('click', (e) => {
      if (e.target.id === 'user-modal') closeModal();
    });

    function readCachedLeaderboard() {
      try {
        const raw = localStorage.getItem(LEADERBOARD_CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed?.entries)) return null;
        return parsed.entries;
      } catch (error) {
        localStorage.removeItem(LEADERBOARD_CACHE_KEY);
        return null;
      }
    }

    function writeCachedLeaderboard(entries) {
      localStorage.setItem(
        LEADERBOARD_CACHE_KEY,
        JSON.stringify({ entries, updatedAt: Date.now() })
      );
    }

    function setupSearch(tbody, mobile) {
      const searchInput = document.getElementById("search-input");
      if (!searchInput) return;
      searchInput.oninput = e => {
        clearTimeout(searchTimeout);
        const val = e.target.value.toLowerCase();

        searchTimeout = setTimeout(() => {
          let visibleCount = 0;

          Array.from(tbody.children).forEach(row => {
            if (row.classList.contains('no-results-row')) {
              row.remove();
              return;
            }
            const teamName = row.children[1]?.textContent.toLowerCase();
            const isVisible = !val || teamName?.includes(val);
            row.style.display = isVisible ? "" : "none";
            if (isVisible) visibleCount++;
          });

          Array.from(mobile.children).forEach(card => {
            const isVisible = !val || card.textContent.toLowerCase().includes(val);
            card.style.display = isVisible ? "" : "none";
          });

          if (visibleCount === 0 && val) {
            const noResults = document.createElement("tr");
            noResults.className = 'no-results-row';
            noResults.innerHTML = '<td colspan="4" class="px-4 py-8 text-center text-gray-400">No teams found matching your search.</td>';
            tbody.appendChild(noResults);
          }
        }, 150);
      };
    }

    function renderLeaderboard(entries) {
      const tbody = document.getElementById("leaderboard-body");
      const mobile = document.getElementById("leaderboard-mobile");
      tbody.innerHTML = "";
      mobile.innerHTML = "";

      if (!entries || entries.length === 0) {
        const emptyMsg = document.createElement("tr");
        emptyMsg.innerHTML = '<td colspan="4" class="px-6 py-12 text-center text-gray-400 text-base">No leaderboard data available yet.</td>';
        tbody.appendChild(emptyMsg);
        setupSearch(tbody, mobile);
        return;
      }

      entries.forEach((entry, i) => {
        const tr = document.createElement("tr");
        tr.className = "table-row";

        let rankClass = "rank-other";
        if (i === 0) rankClass = "rank-1";
        else if (i === 1) rankClass = "rank-2";
        else if (i === 2) rankClass = "rank-3";

        const isVerified = entry.teamName === 'The Mock Cashy' || entry.teamName === 'The Mock Nick';
        const isDeveloper = entry.teamName === 'RyzyO';
        const verifiedBadge = isVerified ? '<svg class="h-4 w-4 ml-1" style="display: inline-block; vertical-align: middle;" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#1DA1F2"/><path d="M9.5 14.5L6 11L7.5 9.5L9.5 11.5L14.5 6.5L16 8L9.5 14.5Z" fill="white"/></svg>' : '';
        const developerBadge = isDeveloper ? '<svg class="h-4 w-4 ml-1" style="display: inline-block; vertical-align: middle;" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#10B981"/><path d="M8 7L6 11L8 15M14 7L16 11L14 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' : '';
        const silkNumber = entry.silk || 1;
        
        tr.innerHTML = `
          <td class="px-6 py-4">
            <div class="rank-badge ${rankClass}">${i + 1}</div>
          </td>
          <td class="px-6 py-4 font-semibold text-gray-100">
            <div class="flex items-center gap-2">
              <img src="static/silks/${silkNumber}.png" alt="Silk" class="w-12 h-12 rounded-lg object-cover border border-gray-600">
              <span>${entry.teamName || entry.userId}</span>${verifiedBadge}${developerBadge}
            </div>
          </td>
          <td class="px-6 py-4 text-right">
            <span class="text-xl font-bold text-yellow-400">${entry.points.toFixed(2)}</span>
          </td>
          <td class="px-6 py-4 text-center">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-yellow-500/20 border border-yellow-500/30 text-yellow-400 font-semibold text-sm">${entry.jokers}</span>
          </td>
        `;
        tr.onclick = () => loadUserResults(entry);
        tr.setAttribute('role', 'button');
        tr.setAttribute('tabindex', '0');
        tr.setAttribute('aria-label', `${entry.teamName || entry.userId}, ${entry.points} points, click to view details`);
        tr.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') loadUserResults(entry);
        });
        tbody.appendChild(tr);

        const card = document.createElement("div");
        card.className = "leaderboard-card p-5 rounded-xl shadow cursor-pointer";

        let rankBadgeClass = "rank-other";
        if (i === 0) rankBadgeClass = "rank-1";
        else if (i === 1) rankBadgeClass = "rank-2";
        else if (i === 2) rankBadgeClass = "rank-3";

        card.innerHTML = `
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-3 flex-1">
              <div class="rank-badge ${rankBadgeClass}" style="width: 2.5rem; height: 2.5rem;">${i + 1}</div>
              <img src="static/silks/${silkNumber}.png" alt="Silk" class="w-14 h-14 rounded-lg object-cover border border-gray-600 flex-shrink-0">
              <div class="flex-1 min-w-0">
                <h4 class="font-bold text-gray-100 truncate flex items-center gap-1">
                  <span>${entry.teamName || entry.userId}</span>
                  ${isVerified ? '<svg class="h-4 w-4 flex-shrink-0" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#1DA1F2"/><path d="M9.5 14.5L6 11L7.5 9.5L9.5 11.5L14.5 6.5L16 8L9.5 14.5Z" fill="white"/></svg>' : ''}
                  ${isDeveloper ? '<svg class="h-4 w-4 flex-shrink-0" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="11" fill="#10B981"/><path d="M8 7L6 11L8 15M14 7L16 11L14 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' : ''}
                </h4>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-black/30 rounded-lg p-3">
              <p class="text-xs text-gray-400 mb-1">Points</p>
              <p class="text-xl font-bold text-yellow-400">${entry.points.toFixed(2)}</p>
            </div>
            <div class="bg-black/30 rounded-lg p-3">
              <p class="text-xs text-gray-400 mb-1">Jokers</p>
              <p class="text-xl font-bold text-yellow-400">${entry.jokers}</p>
            </div>
          </div>
        `;
        card.onclick = () => loadUserResults(entry);
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', `${entry.teamName || entry.userId}, ${entry.points} points, click to view details`);
        card.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') loadUserResults(entry);
        });
        mobile.appendChild(card);
      });

      setupSearch(tbody, mobile);
    }

    const cached = readCachedLeaderboard();
    if (cached) {
      cachedLeaderboard = cached;
      renderLeaderboard(cachedLeaderboard);
    }

    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      await loadLeaderboard();
    });

    async function loadLeaderboard() {
      showLoading();
      try {
        const leaderboardSnap = await getDocs(collection(db, "leaderboard"));
        const usersSnap = await getDocs(collection(db, "users"));

        const jokersMap = {};
        const silksMap = {};
        usersSnap.forEach(d => {
          jokersMap[d.id] = d.data().joker ?? 0;
          silksMap[d.id] = d.data().silk || 1;
        });

        cachedLeaderboard = [];
        leaderboardSnap.forEach(docSnap => {
          const d = docSnap.data();
          let pts = parseFloat(d.points) || 0;
          cachedLeaderboard.push({
            userId: docSnap.id,
            teamName: d.teamName,
            points: pts,
            jokers: jokersMap[docSnap.id] || 0,
            silk: silksMap[docSnap.id] || 1
          });
        });

        cachedLeaderboard.sort((a, b) => b.points - a.points);

        renderLeaderboard(cachedLeaderboard);
        writeCachedLeaderboard(cachedLeaderboard);
        hideLoading();
      } catch (error) {
        console.error('Error loading leaderboard:', error);
        hideLoading();
        alert('Failed to load leaderboard. Please refresh the page.');
      }
    }

    async function loadUserResults(entry) {
      showLoading();
      try {
        // Load all data once on first modal open
        if (Object.keys(cachedRaces).length === 0) {
          const [tipsSnap, resultsSnap, racesSnap] = await Promise.all([
            getDocs(collection(db, "tips")),
            getDocs(collection(db, "results")),
            getDocs(collection(db, "races"))
          ]);

          racesSnap.forEach(d => cachedRaces[d.id] = d.data());
          resultsSnap.forEach(d => cachedResults[d.id] = d.data());
          tipsSnap.forEach(d => {
            const t = d.data();
            if (!cachedTips[t.userId]) cachedTips[t.userId] = {};
            cachedTips[t.userId][t.raceId] = t;
          });
        }

        // Use cached user tips directly
        const userTips = cachedTips[entry.userId] || {};
        const container = document.getElementById("modal-user-results");
        container.innerHTML = "";

        let resultCount = 0;
        const fragment = document.createDocumentFragment();

        for (const [raceId, race] of Object.entries(cachedRaces)) {
          if (!cachedResults[raceId]) continue;
          const res = cachedResults[raceId];
          const tip = userTips[raceId];
          if (!tip) continue;

          resultCount++;

          const winnerPoints = parseFloat(res.points) || 0;
          const place1Points = parseFloat(res.place1Points) || 0;
          const place2Points = parseFloat(res.place2Points) || 0;
          const place3Points = parseFloat(res.place3Points) || 0;

          const winnerName = race.horses?.[res.winningHorseId]?.name || "—";
          const place1Name = race.horses?.[res.place1HorseId]?.name || "—";
          const place2Name = race.horses?.[res.place2HorseId]?.name || "—";
          const place3Name = race.horses?.[res.place3HorseId]?.name || "—";
          const dateStr = race.date ? DateTime.fromISO(race.date).toFormat("dd/LL/yyyy") : "—";

          let pts = 0, correct = false;
          if (tip.horseId === res.winningHorseId) {
            pts = winnerPoints;
            correct = true;
          } else if (tip.horseId === res.place1HorseId) {
            pts = place1Points;
            correct = true;
          } else if (tip.horseId === res.place2HorseId) {
            pts = place2Points;
            correct = true;
          } else if (tip.horseId === res.place3HorseId) {
            pts = place3Points;
            correct = true;
          }
          if (correct && tip.joker) pts *= 2;

          const div = document.createElement("div");
          div.className = `p-5 rounded-xl border ${correct ? "border-green-500/30 bg-gradient-to-br from-green-900/20 to-green-900/10" : "border-red-500/30 bg-gradient-to-br from-red-900/20 to-red-900/10"}`;
          div.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <h4 class="text-lg font-bold text-white flex-1">${race.name}</h4>
              <span class="text-xs text-gray-400 whitespace-nowrap ml-2">${dateStr}</span>
            </div>
            <div class="space-y-3 text-sm mb-4">
              <div class="flex items-center justify-between p-3 bg-black/30 rounded-lg">
                <span class="text-gray-300">Your tip:</span>
                <div class="flex items-center gap-2">
                  <strong class="text-yellow-400">${race.horses?.[tip.horseId]?.name || "—"}</strong>
                  ${tip.joker ? "<span class='bg-purple-600/80 text-white px-2 py-0.5 rounded text-xs font-semibold'>JOKER</span>" : ""}
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div class="p-3 bg-black/30 rounded-lg">
                  <p class="text-xs text-gray-400 mb-1">1st Place</p>
                  <p class="font-semibold text-gray-200">${winnerName}</p>
                </div>
                <div class="p-3 bg-black/30 rounded-lg">
                  <p class="text-xs text-gray-400 mb-1">2nd Place</p>
                  <p class="font-semibold text-gray-200">${place1Name}</p>
                </div>
                <div class="p-3 bg-black/30 rounded-lg">
                  <p class="text-xs text-gray-400 mb-1">3rd Place</p>
                  <p class="font-semibold text-gray-200">${place2Name}</p>
                </div>
                <div class="p-3 bg-black/30 rounded-lg">
                  <p class="text-xs text-gray-400 mb-1">4th Place</p>
                  <p class="font-semibold text-gray-200">${place3Name}</p>
                </div>
              </div>
            </div>
            <div class="pt-4 border-t border-gray-700/50">
              ${correct ? `<p class="text-green-400 font-bold text-lg">✓ +${pts.toFixed(2)} points</p>` : `<p class="text-red-400 font-semibold">✗ No points</p>`}
            </div>
          `;
          fragment.appendChild(div);
        }

        if (resultCount === 0) {
          container.innerHTML = '<div class="p-8 text-center text-gray-400"><p class="text-base">No results to display yet.</p></div>';
        } else {
          container.appendChild(fragment);
        }

        document.getElementById("modal-user-name").textContent = entry.teamName || entry.userId;
        document.getElementById("user-modal").classList.remove("hidden");
        hideLoading();
      } catch (error) {
        console.error('Error loading user results:', error);
        hideLoading();
        alert('Failed to load team details. Please try again.');
      }
    }

    AOS.init({duration: 1000, once: true});
    feather.replace();
  </script>
</body>
</html>
