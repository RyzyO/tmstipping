<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tip Now - The Great Spring Tip Off</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
   <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#fbbf24">

  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    .gradient-text {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }
    .card {
      background: linear-gradient(145deg, rgba(31, 41, 55, 0.9), rgba(17, 24, 39, 0.9));
      border: 1px solid rgba(75, 85, 99, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
      border-color: rgba(251, 191, 36, 0.3);
    }
    .skeleton {
      background: linear-gradient(90deg, rgba(55, 65, 81, 0.3) 25%, rgba(75, 85, 99, 0.3) 50%, rgba(55, 65, 81, 0.3) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .badge {
      background: rgba(217, 119, 6, 0.2);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }
    .horse-row {
      background: linear-gradient(145deg, rgba(55, 65, 81, 0.9), rgba(31, 41, 55, 0.9));
      border: 2px solid rgba(75, 85, 99, 0.4);
      transition: all 0.2s ease;
    }
    .horse-row:hover {
      border-color: rgba(251, 191, 36, 0.5);
      background: linear-gradient(145deg, rgba(55, 65, 81, 1), rgba(31, 41, 55, 1));
    }
    .horse-row.selected {
      border-color: rgba(251, 191, 36, 0.8);
      background: linear-gradient(145deg, rgba(217, 119, 6, 0.15), rgba(251, 191, 36, 0.1));
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">

  <!-- Navigation -->
  <nav class="sticky top-0 z-50 glass-effect">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <img src="images/logo.png" alt="Logo" class="h-8 w-8 mr-2" style="object-fit:contain;">
          <h1 class="text-xl font-bold gradient-text">The Great Spring Tip Off</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button class="md:hidden" onclick="toggleMenu()">
            <i data-feather="menu" class="h-6 w-6 text-gray-200"></i>
          </button>
          <div class="hidden md:flex space-x-6">
            <a href="dark.html" class="text-gray-300 hover:text-yellow-400 transition">Home</a>
            <a href="tipdark.html" class="text-gray-300 hover:text-yellow-400 transition">Tip Now</a>
            <a href="leaderboarddark.html" class="text-gray-300 hover:text-yellow-400 transition">Leaderboard</a>
            <a href="resultsdark.html" class="text-gray-300 hover:text-yellow-400 transition">Results</a>
            <a href="podcastdark.html" class="text-gray-300 hover:text-yellow-400 transition">Podcast</a>
            <a href="faqdark.html" class="text-gray-300 hover:text-yellow-400 transition">FAQ</a>
            <a href="prizesdark.html" class="text-gray-300 hover:text-yellow-400 transition">Prizes</a>
          </div>
        </div>
      </div>
    </div>
    <div id="mobileMenu" class="hidden md:hidden glass-effect px-4 py-2 space-y-2">
      <a href="dark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Home</a>
      <a href="tipdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Tip Now</a>
      <a href="leaderboarddark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Leaderboard</a>
      <a href="resultsdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Results</a>
      <a href="podcastdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Podcast</a>
      <a href="faqdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">FAQ</a>
      <a href="prizesdark.html" class="block py-2 text-gray-300 hover:text-yellow-400 transition">Prizes</a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">

    <!-- Race List Section -->
    <section id="race-list-section" data-aos="fade-up">
      <div class="card rounded-2xl shadow-2xl p-6 md:p-8 mb-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-2 gradient-text">Select a Race</h2>
        <p class="text-sm text-gray-300 flex items-center justify-center">
          <i data-feather="alert-circle" class="h-4 w-4 mr-2 text-yellow-400"></i>
          Tipping closes 5 minutes before the jump
        </p>
      </div>
      <div id="raceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
        <!-- Loading skeletons -->
        <div class="card rounded-xl shadow-lg overflow-hidden skeleton-card">
          <div class="h-36 skeleton"></div>
          <div class="p-6 space-y-3">
            <div class="h-6 skeleton rounded w-3/4"></div>
            <div class="h-4 skeleton rounded w-1/2"></div>
            <div class="h-10 skeleton rounded mt-4"></div>
          </div>
        </div>
        <div class="card rounded-xl shadow-lg overflow-hidden skeleton-card hidden md:block">
          <div class="h-36 skeleton"></div>
          <div class="p-6 space-y-3">
            <div class="h-6 skeleton rounded w-3/4"></div>
            <div class="h-4 skeleton rounded w-1/2"></div>
            <div class="h-10 skeleton rounded mt-4"></div>
          </div>
        </div>
        <div class="card rounded-xl shadow-lg overflow-hidden skeleton-card hidden lg:block">
          <div class="h-36 skeleton"></div>
          <div class="p-6 space-y-3">
            <div class="h-6 skeleton rounded w-3/4"></div>
            <div class="h-4 skeleton rounded w-1/2"></div>
            <div class="h-10 skeleton rounded mt-4"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Race Card Section (hidden until a race is selected) -->
    <section id="race-card-section" class="hidden" data-aos="fade-up">
      <div class="w-full">
        <button id="exit-race-btn" class="mb-6 px-5 py-2.5 card rounded-lg hover:border-yellow-500/50 transition-all flex items-center gap-2 text-gray-200 font-medium">
          <i data-feather="arrow-left" class="h-4 w-4"></i>
          Back to Races
        </button>
        <div class="card rounded-2xl shadow-2xl p-6 md:p-8 mb-6">
          <h2 id="selected-race-title" class="text-2xl md:text-3xl font-bold gradient-text mb-3"></h2>
          <div class="flex flex-wrap gap-4 text-sm text-gray-300 mb-2">
            <div class="flex items-center gap-2">
              <i data-feather="activity" class="h-4 w-4 text-yellow-400"></i>
              <span id="race-distance"></span>
            </div>
            <div class="flex items-center gap-2">
              <i data-feather="calendar" class="h-4 w-4 text-yellow-400"></i>
              <span id="selected-race-date"></span>
            </div>
          </div>
        </div>
        <form id="tip-form" class="space-y-6">
          <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center gap-2">
              <i data-feather="list" class="h-5 w-5 text-yellow-400"></i>
              Select Your Horse
            </h3>
            <div id="horses-radio-list" class="space-y-3"></div>
          </div>
          <div class="space-y-3">
            <button type="submit" id="submit-tip-btn" class="w-full py-3 rounded-lg bg-gradient-to-r from-yellow-500 to-amber-500 text-gray-900 font-semibold hover:from-yellow-400 hover:to-amber-400 transition-all duration-200 shadow-lg shadow-yellow-900/30">
              Submit Your Tip
            </button>
            <div class="flex gap-3">
              <button type="button" id="use-joker-btn" class="flex-1 bg-gradient-to-r from-violet-600 to-purple-600 text-white font-semibold py-2.5 rounded-lg hover:from-violet-500 hover:to-purple-500 transition-all shadow-lg shadow-purple-900/30 hidden flex items-center justify-center gap-2">
                <i data-feather="zap" class="h-4 w-4"></i>
                Use Joker (<span id="joker-count">0</span>)
              </button>
              <button type="button" id="remove-joker-btn" class="flex-1 border-2 border-yellow-500 text-yellow-400 font-semibold py-2.5 rounded-lg hover:bg-yellow-500 hover:text-gray-900 transition-all hidden flex items-center justify-center gap-2">
                <i data-feather="x-circle" class="h-4 w-4"></i>
                Remove Joker
              </button>
            </div>
          </div>
        </form>
        <div id="tip-message" class="mt-6 text-center font-medium"></div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="bg-gray-950 border-t border-gray-800 text-gray-400 py-10 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex flex-col items-center md:items-start">
          <div class="flex items-center mb-2">
            <img src="images/logo.png" alt="Logo" class="h-6 w-6 mr-2" style="object-fit: contain;" />
            <span class="font-semibold text-gray-300">The Mock Sports</span>
          </div>
          <p class="text-sm text-gray-500">&copy; 2026 All rights reserved.</p>
        </div>
        <div class="flex space-x-6">
          <a href="https://x.com/themocksports" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition-colors duration-200" aria-label="Follow us on X">
            <i data-feather="twitter" class="h-5 w-5"></i>
          </a>
          <a href="https://facebook.com/TheMockSports" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition-colors duration-200" aria-label="Follow us on Facebook">
            <i data-feather="facebook" class="h-5 w-5"></i>
          </a>
          <a href="https://instagram.com/themocksports" target="_blank" rel="noopener noreferrer" class="hover:text-yellow-400 transition-colors duration-200" aria-label="Follow us on Instagram">
            <i data-feather="instagram" class="h-5 w-5"></i>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 z-50 bg-black/80 hidden items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-yellow-500 border-t-transparent mx-auto"></div>
      <p class="mt-4 text-yellow-400 font-semibold">Loading…</p>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, getDoc, query, where, runTransaction, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    const { DateTime } = luxon;

    const firebaseConfig = {
      apiKey: "AIzaSyCrgNrA4n62hg1U3ujZMRCOYcbLcwT77ZA",
      authDomain: "tmstipping.firebaseapp.com",
      projectId: "tmstipping",
      storageBucket: "tmstipping.appspot.com",
      messagingSenderId: "401677933527",
      appId: "1:401677933527:web:2312ad4ef69aef6551c992",
      measurementId: "G-GXLRCHV687"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const state = { user:null, tipsMap:{}, jokerCount:0, selectedRaceId:null, inFlight:false, racesCache:{}, userTipsCache:{}, pendingRaceId:null };

    const urlParams = new URLSearchParams(window.location.search);
    state.pendingRaceId = urlParams.get('raceId');

    function showLoading(){ document.getElementById('loading-overlay').classList.remove('hidden'); }
    function hideLoading(){ document.getElementById('loading-overlay').classList.add('hidden'); }
    function setBusy(b){ state.inFlight=b; if(b) showLoading(); else hideLoading(); }

    onAuthStateChanged(auth, async (_user)=>{
      setBusy(true);
      try{
        if(!_user){ 
          setBusy(false); 
          window.location.href="login.html"; 
          return; 
        }
        state.user=_user;
        const userRef=doc(db,"users",state.user.uid);
        const userSnap=await getDoc(userRef);
        if(!userSnap.exists()||userSnap.data().paid!==true){ alert("Your account is locked."); await signOut(auth); window.location.href="login.html"; return; }
        await refreshJokerCount(); await loadUserTips(); await loadRaces();
      }finally{ setBusy(false); }
    });

    async function refreshJokerCount(){
      const snap=await getDoc(doc(db,"users",state.user.uid));
      let count=0; if(snap.exists()&&!isNaN(snap.data().joker)) count=Number(snap.data().joker);
      state.jokerCount=Math.max(0,count); document.getElementById('joker-count').textContent=state.jokerCount;
    }
    async function loadUserTips(){
      state.tipsMap={}; const tipsQ=query(collection(db,"tips"),where("userId","==",state.user.uid));
      const tipsSnap=await getDocs(tipsQ); tipsSnap.forEach(d=>{ if(d.data().raceId) state.tipsMap[d.data().raceId]=true; });
    }

    async function loadRaces(){
      const grid=document.getElementById('raceGrid'); grid.innerHTML="";
      const racesSnap=await getDocs(collection(db,"races")); const now=DateTime.now().setZone("Australia/Sydney");
      const races=[]; racesSnap.forEach(docSnap=>races.push({id:docSnap.id,...docSnap.data()}));
      races.sort((a,b)=>DateTime.fromISO(a.date+"T"+a.time,{zone:"Australia/Sydney"})-DateTime.fromISO(b.date+"T"+b.time,{zone:"Australia/Sydney"}));
      
      // Prefetch next 3 upcoming races
      let prefetched = 0;
      const prefetchPromises = [];
      for(const race of races){
        const dt=DateTime.fromISO(race.date+"T"+race.time,{zone:"Australia/Sydney"});
        if(dt<now) continue;
        if(prefetched < 3) {
          prefetchPromises.push(prefetchRaceData(race.id));
          prefetched++;
        }
      }
      Promise.all(prefetchPromises).catch(err => console.log('Prefetch error:', err));
      
      let shown=0;
      for(const race of races){
        const dt=DateTime.fromISO(race.date+"T"+race.time,{zone:"Australia/Sydney"});
        if(dt<now) continue; shown++;
        let photo="default.jpg"; const n=(race.name||"").toLowerCase();
        if(n.includes("valley")) photo="valley.jpg"; else if(n.includes("randwick")) photo="randwick.jpg"; else if(n.includes("rosehill")) photo="rosehill.jpg"; else if(n.includes("caulfield")) photo="caulfield.jpg"; else if(n.includes("flemington")) photo="flemington.jpg";
        const isLocked=now>=dt.minus({minutes:5}); const timerId="timer-"+race.id; const tipped=state.tipsMap[race.id];
        const previewUrl=(race.preview||"").trim(); const hasPreview=previewUrl.length>0;
        
        // Extract race number from race name
        const raceNumMatch = (race.name||"").match(/race\s*(\d+)/i);
        const raceNum = raceNumMatch ? raceNumMatch[1] : "";
        
        const card=document.createElement("div"); card.className="card rounded-xl shadow-lg overflow-hidden";
        card.innerHTML=`
          <div class="h-36 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/50 to-transparent z-10"></div>
            <img src="images/${photo}" alt="Race track" class="w-full h-full object-cover" onerror="this.src='images/default.jpg'">
          </div>
          <div class="p-6">
            <div class="flex justify-between items-start mb-3">
              <div class="flex-1 flex items-start gap-3">
                ${raceNum ? `<div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-yellow-500 to-amber-600 flex items-center justify-center font-bold text-gray-900 text-lg shadow-lg">${raceNum}</div>` : ''}
                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-bold text-gray-100 mb-1 line-clamp-2">${race.name}</h3>
                  <div class="flex items-center text-sm text-gray-400">
                    <i data-feather="clock" class="h-4 w-4 mr-1"></i>
                    <span>${dt.toFormat("EEE, LLL d • h:mm a")}</span>
                  </div>
                </div>
              </div>
              <span class="badge text-yellow-300 px-2.5 py-1 rounded-lg text-xs font-medium whitespace-nowrap ml-2">${race.type||"Open"}</span>
            </div>
            <div class="mb-4"><div id="${timerId}" class="${isLocked?'bg-red-900/20 border border-red-700/30 text-red-400':'bg-gray-800/50 border border-gray-700 text-yellow-400'} text-center py-2 rounded-lg text-sm font-semibold"></div></div>
            <div class="space-y-2">
              <button ${isLocked?"disabled":""} onclick="selectRace('${race.id}')" class="w-full py-2.5 rounded-lg font-semibold transition-all duration-200 ${isLocked?"bg-gray-700 text-gray-500 cursor-not-allowed":tipped?"bg-green-600 text-white hover:bg-green-500":"bg-gradient-to-r from-yellow-500 to-amber-500 text-gray-900 hover:from-yellow-400 hover:to-amber-400 shadow-lg shadow-yellow-900/30"}">${tipped?"✔ Tip Submitted":isLocked?"⛔ Closed":"Tip Now"}</button>
              ${hasPreview?`<a href="${previewUrl}" target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center py-2.5 rounded-lg font-semibold text-white bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-500 hover:to-rose-500 transition-all duration-200 shadow-lg shadow-red-900/30">Preview</a>`:""}
            </div>
          </div>`;
        grid.appendChild(card); startCountdown(timerId,dt.minus({minutes:5}).toMillis());
      }
      feather.replace();
      if(state.pendingRaceId){
        const raceExists = races.some(r => r.id === state.pendingRaceId);
        if(raceExists){
          const raceId = state.pendingRaceId;
          state.pendingRaceId = null;
          await window.selectRace(raceId);
        }
      }
      if(shown===0) {
        grid.innerHTML=`
          <div class="col-span-full card rounded-xl p-12 text-center">
            <div class="max-w-sm mx-auto">
              <div class="w-16 h-16 mx-auto mb-4 bg-gray-800 rounded-full flex items-center justify-center">
                <i data-feather="calendar" class="h-8 w-8 text-gray-500"></i>
              </div>
              <h3 class="text-lg font-semibold text-gray-300 mb-2">No Upcoming Races</h3>
              <p class="text-gray-500 text-sm">Check back soon for new racing opportunities!</p>
            </div>
          </div>
        `;
        feather.replace();
      }
    }

    async function prefetchRaceData(raceId) {
      if(state.racesCache[raceId]) return; // Already cached
      try {
        const [raceSnap, tipSnap] = await Promise.all([
          getDoc(doc(db,"races",raceId)),
          getDoc(doc(db,"tips",state.user.uid+"_"+raceId))
        ]);
        if(raceSnap.exists()) state.racesCache[raceId] = raceSnap.data();
        if(tipSnap.exists()) state.userTipsCache[raceId] = tipSnap.data();
      } catch(err) {
        console.log('Prefetch failed for race:', raceId, err);
      }
    }

    function startCountdown(id,target){const el=document.getElementById(id);if(!el)return;function u(){const diff=target-DateTime.now().toMillis();if(diff<=0){el.textContent="⛔ Tipping Closed";el.className="bg-red-900/20 border border-red-700/30 text-red-400 text-center py-2 rounded-lg text-sm font-semibold";clearInterval(t);}else{const d=Math.floor(diff/86400000),h=Math.floor(diff/3600000)%24,m=Math.floor(diff/60000)%60,s=Math.floor(diff/1000)%60;let txt="Closes in: ";if(d>0)txt+=d+"d ";if(h>0||d>0)txt+=h+"h ";txt+=m+"m "+s+"s";el.textContent=txt;}}u();const t=setInterval(u,1000);}

    window.selectRace=async(raceId)=>{ 
      // Use cached data if available for instant load
      const useCached = state.racesCache[raceId] ? true : false;
      if(!useCached) setBusy(true); 
      
      try{ 
        state.selectedRaceId=raceId; 
        document.getElementById("race-list-section").classList.add("hidden"); 
        document.getElementById("race-card-section").classList.remove("hidden");
        
        // Get race data from cache or fetch
        let race, tipSnap;
        if(useCached) {
          race = state.racesCache[raceId];
          tipSnap = { exists: () => !!state.userTipsCache[raceId], data: () => state.userTipsCache[raceId] || {} };
        } else {
          const raceDoc = await getDoc(doc(db,"races",raceId));
          race = raceDoc.data();
          tipSnap = await getDoc(doc(db,"tips",state.user.uid+"_"+raceId));
          // Cache for next time
          state.racesCache[raceId] = race;
          if(tipSnap.exists()) state.userTipsCache[raceId] = tipSnap.data();
        }
        
        const dt=DateTime.fromISO(race.date+"T"+race.time,{zone:"Australia/Sydney"}); 
        const now=DateTime.now().setZone("Australia/Sydney"); 
        const isLocked=now>=dt.minus({minutes:5});
        
        document.getElementById("selected-race-title").textContent=race.name; 
        document.getElementById("selected-race-date").textContent=dt.toFormat("EEE, LLL d • h:mm a"); 
        document.getElementById("race-distance").textContent=(race.distance||"N/A");
        
        let tippedHorseId=null,prevJoker=false; 
        if(tipSnap.exists()){
          tippedHorseId=tipSnap.data().horseId||null;
          prevJoker=tipSnap.data().joker===true;
        }
        
        renderHorsesRadioList(race,tippedHorseId); 
        document.getElementById("tip-form").style.display=isLocked?"none":""; 
        document.getElementById("tip-message").textContent=isLocked?"⛔ Tipping is closed for this race":""; 
        document.getElementById("tip-message").className=isLocked?"mt-6 text-center font-medium text-red-400":"mt-6 text-center font-medium"; 
        
        await refreshJokerCount(); 
        document.getElementById("joker-count").textContent=state.jokerCount;
        
        const useJokerBtn = document.getElementById("use-joker-btn");
        const shouldShowUseJoker = !isLocked && !prevJoker;
        useJokerBtn.classList.toggle("hidden", !shouldShowUseJoker);
        
        if(shouldShowUseJoker) {
          if(state.jokerCount === 0) {
            useJokerBtn.className = "flex-1 bg-gradient-to-r from-gray-600 to-gray-700 text-gray-400 font-semibold py-2.5 rounded-lg cursor-not-allowed flex items-center justify-center gap-2";
            useJokerBtn.disabled = true;
          } else {
            useJokerBtn.className = "flex-1 bg-gradient-to-r from-violet-600 to-purple-600 text-white font-semibold py-2.5 rounded-lg hover:from-violet-500 hover:to-purple-500 transition-all shadow-lg shadow-purple-900/30 flex items-center justify-center gap-2";
            useJokerBtn.disabled = false;
          }
        }
        
        document.getElementById("remove-joker-btn").classList.toggle("hidden",isLocked||!prevJoker);
        feather.replace();
      } finally {
        if(!useCached) setBusy(false);
      } 
    };

    function renderHorsesRadioList(race,tippedHorseId){
      const list=document.getElementById("horses-radio-list");
      list.innerHTML="";
      Object.entries(race.horses||{}).filter(([_,h])=>!h.scratched).sort((a,b)=>a[1].number-b[1].number).forEach(([id,h])=>{
        const d=document.createElement("div");
        d.className="horse-row rounded-lg p-4 cursor-pointer";
        d.dataset.horseId=id;
        
        // Try to construct TAB silk URL - using race venue and number
        const venueName = (race.name||"").toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        const silkUrl = h.silkUrl || `https://content.tab.com.au/content/dam/tab-corp/silks/${venueName}/${h.number}.png`;
        
        d.innerHTML=`
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 w-12 h-12 rounded-lg overflow-hidden bg-gradient-to-br from-gray-700 to-gray-800 border border-gray-600 flex items-center justify-center relative">
              <img src="${silkUrl}" 
                   alt="Silk ${h.number}" 
                   class="w-full h-full object-cover silk-img"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                   style="display: block;">
              <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/20 to-amber-600/20 border border-yellow-500/30 items-center justify-center font-bold text-yellow-400 text-lg" style="display: none;">
                ${h.number}
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-baseline gap-3 mb-1">
                
                <span class="font-bold text-gray-100 text-base">${h.name}${h.barrier ? ` (${h.barrier})` : ''}</span>
              </div>
              <div class="text-sm text-gray-400 leading-relaxed">
                <div class="mb-0.5"><span class="font-semibold text-gray-300">J</span> ${h.jockey||"Unknown"} ${h.weight?h.weight:''}</div>
                <div><span class="font-semibold text-gray-300">T</span> ${h.trainer||"Unknown"}</div>
              </div>
            </div>
          </div>
        `;
        
        if(id===tippedHorseId)d.classList.add("selected");
        d.onclick=()=>{
          document.querySelectorAll(".horse-row").forEach(e=>e.classList.remove("selected"));
          d.classList.add("selected");
        };
        list.appendChild(d);
      });
    }
    function getSelectedHorseId(){const sel=document.querySelector(".horse-row.selected");return sel?sel.dataset.horseId:null;}

    // Submit tip
    document.getElementById("tip-form").onsubmit=async e=>{e.preventDefault();if(!state.selectedRaceId||!state.user||state.inFlight)return;const horseId=getSelectedHorseId();if(!horseId){alert("Select a horse");return;}setBusy(true);try{const tipId=state.user.uid+"_"+state.selectedRaceId;const tipRef=doc(db,"tips",tipId);const userRef=doc(db,"users",state.user.uid);await runTransaction(db,async tx=>{const tipSnap=await tx.get(tipRef);const userSnap=await tx.get(userRef);let jokers=(userSnap.exists()&&!isNaN(userSnap.data().joker))?Number(userSnap.data().joker):0;const prevJ=tipSnap.exists()?tipSnap.data().joker===true:false;if(prevJ)tx.set(userRef,{joker:increment(1)},{merge:true});tx.set(tipRef,{userId:state.user.uid,raceId:state.selectedRaceId,horseId,joker:false,timestamp:serverTimestamp()},{merge:true});});await refreshJokerCount();await loadUserTips();await loadRaces();document.getElementById("race-card-section").classList.add("hidden");document.getElementById("race-list-section").classList.remove("hidden");}finally{setBusy(false);}};

    document.getElementById("use-joker-btn").onclick=async()=>{
      if(state.jokerCount === 0) return; // Do nothing if no jokers
      const horseId=getSelectedHorseId();
      if(!horseId){alert("Select a horse");return;}
      if(!confirm("Use Joker?"))return;
      setBusy(true);
      try{const tipId=state.user.uid+"_"+state.selectedRaceId;const tipRef=doc(db,"tips",tipId);const userRef=doc(db,"users",state.user.uid);await runTransaction(db,async tx=>{const tipSnap=await tx.get(tipRef);const userSnap=await tx.get(userRef);let jokers=(userSnap.exists()&&!isNaN(userSnap.data().joker))?Number(userSnap.data().joker):0;const prev=tipSnap.exists()?tipSnap.data().joker===true:false;if(!prev){if(jokers<=0)throw new Error("No jokers left");tx.set(userRef,{joker:increment(-1)},{merge:true});}tx.set(tipRef,{userId:state.user.uid,raceId:state.selectedRaceId,horseId,joker:true,timestamp:serverTimestamp()},{merge:true});});await refreshJokerCount();await loadUserTips();await loadRaces();document.getElementById("race-card-section").classList.add("hidden");document.getElementById("race-list-section").classList.remove("hidden");}catch(err){alert(err.message);}finally{setBusy(false);}};

    document.getElementById("remove-joker-btn").onclick=async()=>{const horseId=getSelectedHorseId();if(!horseId){alert("Select a horse");return;}setBusy(true);try{const tipId=state.user.uid+"_"+state.selectedRaceId;const tipRef=doc(db,"tips",tipId);const userRef=doc(db,"users",state.user.uid);await runTransaction(db,async tx=>{const tipSnap=await tx.get(tipRef);const prev=tipSnap.exists()?tipSnap.data().joker===true:false;if(prev)tx.set(userRef,{joker:increment(1)},{merge:true});tx.set(tipRef,{userId:state.user.uid,raceId:state.selectedRaceId,horseId,joker:false,timestamp:serverTimestamp()},{merge:true});});await refreshJokerCount();await loadUserTips();await loadRaces();document.getElementById("race-card-section").classList.add("hidden");document.getElementById("race-list-section").classList.remove("hidden");}finally{setBusy(false);}};

    document.getElementById("exit-race-btn").onclick=()=>{if(state.inFlight)return;document.getElementById("race-card-section").classList.add("hidden");document.getElementById("race-list-section").classList.remove("hidden");};

    AOS.init({duration:800,once:true,offset:50}); feather.replace();
    window.toggleMenu=()=>document.getElementById("mobileMenu").classList.toggle("hidden");
    setTimeout(()=>feather.replace(),100);
  </script>
</body>
</html>
