<!doctype html>
<html lang="en">
<head>
    <title>Admin - Mock Sports Tipping</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
        .admin-flex { display: flex; }
        .admin-main { flex: 2; }
        .admin-sidebar { flex: 1; margin-left: 2rem; border-left: 1px solid #ddd; padding-left: 2rem; }
        .race-list { list-style: none; padding: 0; }
        .race-list li { cursor: pointer; padding: 0.5rem 0; }
        .race-list li.selected { font-weight: bold; color: #007bff; }
        .horse-row input { width: 120px; display: inline-block; margin-right: 8px; }
        .horse-row button { margin-left: 8px; }
        .winner-btn { margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container mt-5 admin-flex">
        <div class="admin-main">
            <button class="btn btn-primary mb-3" id="new-race-btn">New Race</button>
            <div id="race-form-section" style="display:none;">
                <h2>New Race</h2>
                <form id="race-form">
                    <input type="text" class="form-control mb-2" id="race-name" placeholder="Race Name" required>
                    <input type="date" class="form-control mb-2" id="race-date" required>
                    <h5>Horses</h5>
                    <div id="horses-list"></div>
                    <button type="button" class="btn btn-secondary mb-2" id="add-horse-row">Add Another Row</button>
                    <br>
                    <button type="submit" class="btn btn-success">Save Race</button>
                    <button type="button" class="btn btn-link" id="cancel-race-form">Cancel</button>
                </form>
                <hr>
            </div>
            <div id="race-details-section" style="display:none;">
                <h2 id="selected-race-title"></h2>
                <div id="selected-race-date"></div>
                <h5>Horses</h5>
                <div id="selected-horses-list"></div>
                <button class="btn btn-secondary mt-2" id="add-horse-to-race">Add Horse</button>
            </div>
        </div>
        <div class="admin-sidebar">
            <h4>Races</h4>
            <ul id="race-list" class="race-list"></ul>
        </div>
    </div>
    <!-- Winner points modal -->
    <div class="modal" tabindex="-1" id="winnerModal" style="display:none; background:rgba(0,0,0,0.5); position:fixed; top:0; left:0; width:100vw; height:100vh; align-items:center; justify-content:center;">
        <div class="modal-dialog" style="background:#fff; padding:2rem; border-radius:8px;">
            <h5>Enter Points for Winner</h5>
            <input type="number" id="winnerPoints" class="form-control mb-2" min="0" required>
            <button class="btn btn-success" id="saveWinnerPoints">Save</button>
            <button class="btn btn-link" id="cancelWinnerPoints">Cancel</button>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDocs, getDoc, updateDoc, deleteField, deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrgNrA4n62hg1U3ujZMRCOYcbLcwT77ZA",
            authDomain: "tmstipping.firebaseapp.com",
            projectId: "tmstipping",
            storageBucket: "tmstipping.appspot.com",
            messagingSenderId: "401677933527",
            appId: "1:401677933527:web:2312ad4ef69aef6551c992",
            measurementId: "G-GXLRCHV687"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);

        // --- Admin check ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert("You must be logged in."); window.location.href = "index.html"; return;
            }
            const adminRef = ref(rtdb, `users/${user.uid}/admin`);
            const snapshot = await get(adminRef);
            if (!snapshot.exists() || snapshot.val() !== true) {
                alert("You are not authorized to access this page."); window.location.href = "index.html";
            }
        });

        // --- UI State ---
        let racesCache = {};
        let selectedRaceId = null;
        let winnerHorseId = null;

        // --- New Race Modal Logic ---
        document.getElementById('new-race-btn').onclick = () => {
            document.getElementById('race-form-section').style.display = '';
            document.getElementById('race-details-section').style.display = 'none';
            document.getElementById('race-form').reset();
            document.getElementById('horses-list').innerHTML = '';
            addHorseRow();
        };
        document.getElementById('cancel-race-form').onclick = () => {
            document.getElementById('race-form-section').style.display = 'none';
        };
        document.getElementById('add-horse-row').onclick = addHorseRow;

        function addHorseRow(name = '', number = '') {
            const horsesList = document.getElementById('horses-list');
            const div = document.createElement('div');
            div.className = 'horse-row mb-2';
            div.innerHTML = `
                <input type="text" placeholder="Horse Name" class="form-control d-inline-block" style="width:150px;" value="${name}" required>
                <input type="text" placeholder="Horse Number" class="form-control d-inline-block" style="width:100px;" value="${number}" required>
                <button type="button" class="btn btn-danger btn-sm remove-horse-row">Remove</button>
            `;
            div.querySelector('.remove-horse-row').onclick = () => div.remove();
            horsesList.appendChild(div);
        }

        document.getElementById('race-form').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('race-name').value;
            const date = document.getElementById('race-date').value;
            const horses = {};
            document.querySelectorAll('#horses-list .horse-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const horseName = inputs[0].value.trim();
                const horseNumber = inputs[1].value.trim();
                if (horseName && horseNumber) {
                    const horseId = doc(collection(db, "_")).id;
                    horses[horseId] = { name: horseName, number: horseNumber };
                }
            });
            if (Object.keys(horses).length === 0) {
                alert("Please add at least one horse.");
                return;
            }
            await addDoc(collection(db, "races"), { name, date, horses });
            document.getElementById('race-form-section').style.display = 'none';
            await loadRaces();
        };

        // --- Sidebar and Race Selection ---
        async function loadRaces() {
            const raceList = document.getElementById('race-list');
            raceList.innerHTML = '';
            const racesSnap = await getDocs(collection(db, "races"));
            racesCache = {};
            racesSnap.forEach(docSnap => {
                const race = docSnap.data();
                racesCache[docSnap.id] = race;
                const li = document.createElement('li');
                li.textContent = `${race.name} (${race.date})`;
                li.dataset.raceId = docSnap.id;
                li.onclick = () => selectRace(docSnap.id);
                if (selectedRaceId === docSnap.id) li.classList.add('selected');
                raceList.appendChild(li);
            });
        }

        async function selectRace(raceId) {
            selectedRaceId = raceId;
            Array.from(document.querySelectorAll('#race-list li')).forEach(li => {
                li.classList.toggle('selected', li.dataset.raceId === raceId);
            });
            document.getElementById('race-form-section').style.display = 'none';
            document.getElementById('race-details-section').style.display = '';
            const raceDoc = await getDoc(doc(db, "races", raceId));
            const race = raceDoc.data();
            document.getElementById('selected-race-title').textContent = race.name;
            document.getElementById('selected-race-date').textContent = "Date: " + race.date;
            renderHorsesList(race, raceId);
        }

        function renderHorsesList(race, raceId) {
            const horsesDiv = document.getElementById('selected-horses-list');
            horsesDiv.innerHTML = '';
            const horses = race.horses || {};
            for (const [horseId, horseData] of Object.entries(horses)) {
                const row = document.createElement('div');
                row.className = 'horse-row mb-2';
                row.innerHTML = `
                    <input type="text" value="${horseData.name}" class="form-control d-inline-block" style="width:150px;">
                    <input type="text" value="${horseData.number}" class="form-control d-inline-block" style="width:100px;">
                    <button class="btn btn-primary btn-sm winner-btn">Winner</button>
                    <button class="btn btn-danger btn-sm remove-horse-row">Remove</button>
                    <button class="btn btn-secondary btn-sm save-horse-row">Save</button>
                    <span class="points-label"></span>
                `;
                // Winner
                row.querySelector('.winner-btn').onclick = () => showWinnerModal(horseId, raceId);
                // Remove
                row.querySelector('.remove-horse-row').onclick = async () => {
                    if (!confirm("Remove this horse?")) return;
                    const raceRef = doc(db, "races", raceId);
                    await updateDoc(raceRef, { [`horses.${horseId}`]: deleteField() });
                    await selectRace(raceId);
                };
                // Save
                row.querySelector('.save-horse-row').onclick = async () => {
                    const name = row.querySelectorAll('input')[0].value.trim();
                    const number = row.querySelectorAll('input')[1].value.trim();
                    if (!name || !number) { alert("Name and number required."); return; }
                    const raceRef = doc(db, "races", raceId);
                    await updateDoc(raceRef, { [`horses.${horseId}`]: { name, number } });
                    alert("Horse updated!");
                };
                // Show points if winner
                getDoc(doc(db, "results", raceId)).then(resultDoc => {
                    if (resultDoc.exists()) {
                        const result = resultDoc.data();
                        if (result.winningHorseId === horseId) {
                            row.querySelector('.points-label').textContent = `Points: ${result.points}`;
                        }
                    }
                });
                horsesDiv.appendChild(row);
            }
        }

        document.getElementById('add-horse-to-race').onclick = async () => {
            if (!selectedRaceId) return;
            const horseName = prompt("Horse name?");
            if (!horseName) return;
            const horseNumber = prompt("Horse number?");
            if (!horseNumber) return;
            const horseId = doc(collection(db, "_")).id;
            const raceRef = doc(db, "races", selectedRaceId);
            const raceSnap = await getDoc(raceRef);
            const horses = raceSnap.data().horses || {};
            horses[horseId] = { name: horseName, number: horseNumber };
            await updateDoc(raceRef, { horses });
            await selectRace(selectedRaceId);
        };

        // --- Winner Modal Logic ---
        function showWinnerModal(horseId, raceId) {
            winnerHorseId = horseId;
            document.getElementById('winnerModal').style.display = 'flex';
            document.getElementById('winnerPoints').value = '';
            document.getElementById('saveWinnerPoints').onclick = async () => {
                const points = parseInt(document.getElementById('winnerPoints').value, 10);
                if (isNaN(points)) { alert("Enter points."); return; }
                await setDoc(doc(db, "results", raceId), { winningHorseId: horseId, points });
                document.getElementById('winnerModal').style.display = 'none';
                await selectRace(raceId);
            };
            document.getElementById('cancelWinnerPoints').onclick = () => {
                document.getElementById('winnerModal').style.display = 'none';
            };
        }

        // --- Initial load ---
        loadRaces();
    </script>
</body>
</html>