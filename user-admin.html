<!doctype html>
<html lang="en">
<head>
  <title>User Admin - Mock Sports Tipping</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <style>
    .user-admin-container { max-width: 1100px; margin: 2rem auto; }
    .user-list { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
    .user-list-item { cursor: pointer; padding: 0.5rem 1rem; border-bottom: 1px solid #f2f2f2; }
    .user-list-item.selected { background: #f8f9fa; font-weight: bold; }
    .user-edit-section { border: 1px solid #eee; border-radius: 8px; padding: 1.5rem; margin-top: 1rem; }
    .tip-row { border-bottom: 1px solid #eee; padding: 0.5rem 0; }
    .tip-row:last-child { border-bottom: none; }
    .search-bar { margin-bottom: 1rem; }
    .export-btn { float: right; }
    .navbar-brand, .nav-link {
      color: #FFD700 !important;
      font-weight: 600;
      font-family: 'Outfit', sans-serif; /* match results.html */
    }
  </style>
</head>
<body>
<div class="container user-admin-container">
  <a href="admin.html" class="btn btn-link mb-3">&larr; Back to Admin</a>
  <h2>User Admin</h2>
  <div class="mb-4 text-center">
    <h1 id="fees-collected-counter" style="font-size:3rem;">$0</h1>
    <div style="font-size:1.2rem;color:#555;">Fees Collected</div>
  </div>
  <div class="mb-3 d-flex" style="gap:0.5rem;">
    <input type="text" id="user-search" class="form-control search-bar" placeholder="Search users by name, email, or team name...">
    <button class="btn btn-outline-secondary export-btn" id="export-csv">Export CSV</button>
    <button class="btn btn-outline-secondary export-btn" id="export-ladder-csv">Export Ladder</button>
  </div>
  <div class="row">
    <div class="col-md-4">
      <div class="user-list" id="user-list"></div>
      <div style="margin-top:2rem;">
        <h5>Unpaid Players</h5>
        <div class="user-list" id="unpaid-user-list"></div>
      </div>
    </div>
    <div class="col-md-8">
      <div id="user-edit-section" class="user-edit-section" style="display:none;">
        <h4>Edit User</h4>
        <form id="user-edit-form">
          <div class="mb-2">
            <label>Email:</label>
            <input type="email" class="form-control" id="edit-email" required>
          </div>
          <div class="mb-2">
            <label>First Name:</label>
            <input type="text" class="form-control" id="edit-firstName">
          </div>
          <div class="mb-2">
            <label>Last Name:</label>
            <input type="text" class="form-control" id="edit-lastName">
          </div>
          <div class="mb-2">
            <label>Team Name:</label>
            <input type="text" class="form-control" id="edit-teamName">
          </div>
          <div class="mb-2">
            <label>Jokers:</label>
            <input type="number" class="form-control" id="edit-joker" min="0">
          </div>
          <div class="mb-2 form-check">
            <input type="checkbox" class="form-check-input" id="edit-paid">
            <label class="form-check-label" for="edit-paid">Paid</label>
          </div>
          <button type="submit" class="btn btn-success">Save User</button>
        </form>
        <hr>
        <h5>User Tips</h5>
        <div id="user-tips-list"></div>
      </div>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, updateDoc, getDoc, setDoc, query, where
} from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrgNrA4n62hg1U3ujZMRCOYcbLcwT77ZA",
  authDomain: "tmstipping.firebaseapp.com",
  projectId: "tmstipping",
  storageBucket: "tmstipping.appspot.com",
  messagingSenderId: "401677933527",
  appId: "1:401677933527:web:2312ad4ef69aef6551c992",
  measurementId: "G-GXLRCHV687"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const rtdb = getDatabase(app);

let users = [];
let selectedUserId = null;
let races = {};

const userListDiv = document.getElementById('user-list');
const unpaidUserListDiv = document.getElementById('unpaid-user-list');
const searchInput = document.getElementById('user-search');
const feesCounter = document.getElementById('fees-collected-counter');

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("You must be logged in.");
    window.location.href = "index.html";
    return;
  }
  // Simple Realtime DB admin gate
  const adminRef = ref(rtdb, `users/${user.uid}/admin`);
  const snapshot = await get(adminRef);
  if (!snapshot.exists() || snapshot.val() !== true) {
    alert("You are not authorized to access this page.");
    window.location.href = "index.html";
    return;
  }
  await loadRaces();
  await loadUsers();
});

/* -------------------------------
   Data loading
--------------------------------*/
async function loadRaces() {
  races = {};
  const racesSnap = await getDocs(collection(db, "races"));
  racesSnap.forEach(docSnap => {
    races[docSnap.id] = docSnap.data();
  });
}

async function loadUsers() {
  userListDiv.innerHTML = '<div class="text-muted p-2">Loading users...</div>';
  unpaidUserListDiv.innerHTML = '<div class="text-muted p-2">Loading users...</div>';

  const usersSnap = await getDocs(collection(db, "users"));
  users = [];
  let paidCount = 0;

  usersSnap.forEach(docSnap => {
    const userData = docSnap.data();
    users.push({ id: docSnap.id, ...userData });
    if (userData.paid === true) paidCount++;
  });

  // Update fees collected counter ($30 per paid)
  feesCounter.textContent = `$${paidCount * 30}`;

  filterAndRenderLists();
}

/* -------------------------------
   Rendering helpers
--------------------------------*/
function renderUserList(userArr, container) {
  container.innerHTML = '';
  if (userArr.length === 0) {
    container.innerHTML = '<div class="text-muted p-2">No users found.</div>';
    return;
  }
  userArr.forEach(user => {
    const div = document.createElement('div');
    div.className = 'user-list-item' + (user.id === selectedUserId ? ' selected' : '');
    const name = `${user.firstName || ''} ${user.lastName || ''}`.trim();
    div.textContent = `${user.teamName || ''} (${name}) - ${user.email || ''}`;
    div.onclick = () => selectUser(user.id);
    container.appendChild(div);
  });
}

function filterAndRenderLists() {
  const q = (searchInput.value || '').trim().toLowerCase();

  const matches = (u) =>
    ((u.email && u.email.toLowerCase().includes(q)) ||
     (u.firstName && u.firstName.toLowerCase().includes(q)) ||
     (u.lastName && u.lastName.toLowerCase().includes(q)) ||
     (u.teamName && u.teamName.toLowerCase().includes(q)));

  const paidFiltered = users.filter(u => u.paid === true && matches(u));
  const unpaidFiltered = users.filter(u => u.paid !== true && matches(u));

  renderUserList(paidFiltered, userListDiv);
  renderUserList(unpaidFiltered, unpaidUserListDiv);
}

searchInput.oninput = filterAndRenderLists;

/* -------------------------------
   Select & edit user
--------------------------------*/
async function selectUser(userId) {
  selectedUserId = userId;
  // re-apply filters to refresh selected highlight
  filterAndRenderLists();

  document.getElementById('user-edit-section').style.display = '';

  const userDoc = await getDoc(doc(db, "users", userId));
  const user = userDoc.exists() ? userDoc.data() : {};

  document.getElementById('edit-email').value = user.email || '';
  document.getElementById('edit-firstName').value = user.firstName || '';
  document.getElementById('edit-lastName').value = user.lastName || '';
  document.getElementById('edit-teamName').value = user.teamName || '';
  document.getElementById('edit-joker').value =
    typeof user.joker === "number" ? user.joker : (user.joker ? Number(user.joker) : 0);
  document.getElementById('edit-paid').checked = !!user.paid;

  await loadUserTips(userId);
}

document.getElementById('user-edit-form').onsubmit = async function(e) {
  e.preventDefault();
  if (!selectedUserId) return;

  const email = document.getElementById('edit-email').value;
  const firstName = document.getElementById('edit-firstName').value;
  const lastName = document.getElementById('edit-lastName').value;
  const teamName = document.getElementById('edit-teamName').value;
  const paid = document.getElementById('edit-paid').checked;
  const joker = Number(document.getElementById('edit-joker').value) || 0;

  await updateDoc(doc(db, "users", selectedUserId), {
    email, firstName, lastName, teamName, paid, joker
  });

  // keep leaderboard doc's teamName aligned if it exists
  const leaderboardDocRef = doc(db, "leaderboard", selectedUserId);
  const leaderboardDoc = await getDoc(leaderboardDocRef);
  if (leaderboardDoc.exists()) {
    await updateDoc(leaderboardDocRef, { teamName });
  }

  await loadUsers();
  alert("User updated.");
};

/* -------------------------------
   Tips view & save (with points calc)
--------------------------------*/
async function loadUserTips(userId) {
  const tipsDiv = document.getElementById('user-tips-list');
  tipsDiv.innerHTML = 'Loading tips...';

  const tipsSnap = await getDocs(query(collection(db, "tips"), where("userId", "==", userId)));
  const tips = [];
  tipsSnap.forEach(docSnap => tips.push({ id: docSnap.id, ...docSnap.data() }));

  const allRaceIds = Object.keys(races);
  allRaceIds.sort((a, b) => {
    const aDate = new Date(`${races[a].date}T${races[a].time}`);
    const bDate = new Date(`${races[b].date}T${races[b].time}`);
    return aDate - bDate;
  });

  tipsDiv.innerHTML = '';

  for (const raceId of allRaceIds) {
    const race = races[raceId];
    const tip = tips.find(t => t.raceId === raceId);
    const horseId = tip ? tip.horseId : '';
    const horseName = horseId && race.horses && race.horses[horseId] ? race.horses[horseId].name : '';
    const jokerUsed = tip ? tip.joker === true : false;

    // --- Calculate points for this tip based on results ---
    let points = 0;
    let matched = false;

    const resultsSnap = await getDoc(doc(db, "results", raceId));
    const results = resultsSnap.exists() ? resultsSnap.data() : null;

    if (results && horseId) {
      if (results.winningHorseId === horseId) {
        points += Number(results.points) || 0; matched = true;
      }
      if (results.place1HorseId === horseId) {
        points += Number(results.place1Points) || 0; matched = true;
      }
      if (results.place2HorseId === horseId) {
        points += Number(results.place2Points) || 0; matched = true;
      }
      if (matched && jokerUsed && points > 0) {
        points *= 2;
      }
    }

    const row = document.createElement('div');
    row.className = 'tip-row';
    row.innerHTML = `
      <div>
        <strong>${race.name} (${race.date} ${race.time})</strong>
        <select class="form-select form-select-sm d-inline-block" style="width:auto;max-width:240px;" data-race-id="${raceId}">
          <option value="">No Tip</option>
          ${Object.entries(race.horses || {})
            .filter(([_, h]) => !h.scratched)
            .sort((a, b) => (a[1].number || 0) - (b[1].number || 0))
            .map(([hId, h]) =>
              `<option value="${hId}" ${hId === horseId ? 'selected' : ''}>#${h.number} ${h.name}</option>`
            ).join('')}
        </select>
        <button class="btn btn-sm btn-outline-primary save-tip-btn" data-race-id="${raceId}">Save</button>
        <label class="ms-2">
          <input type="checkbox" class="form-check-input joker-checkbox" data-race-id="${raceId}" ${jokerUsed ? 'checked' : ''}>
          Joker
        </label>
        <span class="ms-3" style="font-weight:bold;color:${points > 0 ? 'green' : '#888'};">
          ${points > 0 ? `Points: ${points}` : 'No points'}
        </span>
      </div>
    `;
    tipsDiv.appendChild(row);
  }

  // Save tip handler (writes tip, then recalculates leaderboard for this user)
  tipsDiv.querySelectorAll('.save-tip-btn').forEach(btn => {
    btn.onclick = async function() {
      const raceId = btn.dataset.raceId;
      const select = tipsDiv.querySelector(`select[data-race-id="${raceId}"]`);
      const chosenHorseId = select.value;
      const jokerCheckbox = tipsDiv.querySelector(`.joker-checkbox[data-race-id="${raceId}"]`);
      const joker = jokerCheckbox && jokerCheckbox.checked ? true : false;

      if (!raceId || !selectedUserId) return;

      const tipDocId = `${selectedUserId}_${raceId}`;
      await setDoc(doc(db, "tips", tipDocId), {
        userId: selectedUserId,
        raceId,
        horseId: chosenHorseId || "",
        timestamp: Date.now(),
        joker
      });

      // Recalculate only this user's leaderboard now
      await recalculateLeaderboardForUser(selectedUserId);

      alert("Tip updated.");
      loadUserTips(selectedUserId);
    };
  });

  // Joker checkbox handler (instant update + recalc leaderboard)
  tipsDiv.querySelectorAll('.joker-checkbox').forEach(box => {
    box.onchange = async function() {
      const raceId = box.dataset.raceId;
      const tipDocId = `${selectedUserId}_${raceId}`;
      const tipDoc = await getDoc(doc(db, "tips", tipDocId));
      if (!tipDoc.exists()) {
        // if there's no tip yet, create a shell tip with no horse but joker state
        await setDoc(doc(db, "tips", tipDocId), {
          userId: selectedUserId,
          raceId,
          horseId: "",
          timestamp: Date.now(),
          joker: box.checked
        });
      } else {
        const tipData = tipDoc.data();
        await setDoc(doc(db, "tips", tipDocId), { ...tipData, joker: box.checked });
      }

      await recalculateLeaderboardForUser(selectedUserId);
    };
  });
}

/* -------------------------------
   Leaderboard recalculation (per user)
--------------------------------*/
async function recalculateLeaderboardForUser(userId) {
  // ensure races are available
  if (!races || !Object.keys(races).length) await loadRaces();

  // Fetch this user's tips
  const tipsSnap = await getDocs(query(collection(db, "tips"), where("userId", "==", userId)));
  const tipsByRace = {};
  tipsSnap.forEach(d => tipsByRace[d.data().raceId] = d.data());

  let totalPoints = 0;

  for (const raceId of Object.keys(races)) {
    const userTip = tipsByRace[raceId];
    if (!userTip || !userTip.horseId) continue;

    const tipHorseId = userTip.horseId;
    const jokerUsed = !!userTip.joker;

    const resSnap = await getDoc(doc(db, "results", raceId));
    if (!resSnap.exists()) continue;
    const res = resSnap.data();

    let pts = 0;
    let matched = false;

    if (res.winningHorseId === tipHorseId) { pts += Number(res.points) || 0; matched = true; }
    if (res.place1HorseId === tipHorseId)   { pts += Number(res.place1Points) || 0; matched = true; }
    if (res.place2HorseId === tipHorseId)   { pts += Number(res.place2Points) || 0; matched = true; }

    if (matched && jokerUsed && pts > 0) pts *= 2;

    totalPoints += pts;
  }

  // Write/update leaderboard doc
  const userDoc = await getDoc(doc(db, "users", userId));
  const user = userDoc.exists() ? userDoc.data() : {};
  await setDoc(doc(db, "leaderboard", userId), {
    userId,
    teamName: user.teamName || userId,
    points: totalPoints
  }, { merge: true });
}

/* -------------------------------
   Exports
--------------------------------*/
document.getElementById('export-csv').onclick = function() {
  if (!users.length) return;
  const header = ['UserID', 'Email', 'First Name', 'Last Name', 'Team Name', 'Paid'];
  const rows = users.map(u => [
    `"${u.id}"`,
    `"${u.email || ''}"`,
    `"${u.firstName || ''}"`,
    `"${u.lastName || ''}"`,
    `"${u.teamName || ''}"`,
    u.paid === true ? 'true' : 'false'
  ]);
  const csv = header.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'users.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

document.getElementById('export-ladder-csv').onclick = async function() {
  const snapshot = await getDocs(collection(db, "leaderboard"));
  const leaderboard = [];
  snapshot.forEach(docSnap => {
    leaderboard.push({ id: docSnap.id, ...docSnap.data() });
  });
  leaderboard.sort((a, b) => (Number(b.points || 0) - Number(a.points || 0)));

  const header = ['Rank', 'Team Name', 'Points'];
  const rows = leaderboard.map((entry, idx) => [
    idx + 1,
    `"${entry.teamName || entry.userId || entry.id}"`,
    Number(entry.points || 0)
  ]);
  const csv = header.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ladder.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
