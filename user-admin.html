<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>User Admin - Mock Sports Tipping</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f14;
      --bg-2: #0f172a;
      --panel: rgba(17, 24, 39, 0.92);
      --panel-2: rgba(30, 41, 59, 0.7);
      --border: rgba(148, 163, 184, 0.18);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #fbbf24;
      --accent-2: #f97316;
      --success: #34d399;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(249, 115, 22, 0.18), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(59, 130, 246, 0.18), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg-2));
      min-height: 100vh;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 1.25rem 3rem;
    }
    .page-header {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .back-link {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .back-link:hover { color: var(--accent); }
    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.7rem;
      color: var(--muted);
      margin: 0;
    }
    .page-title {
      font-size: clamp(2rem, 3vw, 3rem);
      margin: 0.2rem 0;
      font-weight: 700;
    }
    .subtitle {
      color: var(--muted);
      margin: 0;
      max-width: 520px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
      animation: float-in 0.6s ease;
    }
    .panel-header {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 1rem;
    }
    .panel-header h4,
    .panel-header h5 {
      margin: 0;
      font-weight: 600;
    }
    .panel-hint {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .stat-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.12), rgba(15, 23, 42, 0.95));
      border-color: rgba(251, 191, 36, 0.25);
    }
    .stat-title {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 0.7rem;
      color: var(--muted);
    }
    .stat-value {
      font-size: clamp(2.2rem, 4vw, 3.2rem);
      font-weight: 700;
      color: var(--accent);
    }
    .stat-caption {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .toolbar {
      margin: 1.5rem 0 2rem;
      background: var(--panel-2);
    }
    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }
    .toolbar-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .form-control,
    .form-select {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: var(--text);
      border-radius: 10px;
    }
    .form-control:focus,
    .form-select:focus {
      border-color: rgba(251, 191, 36, 0.6);
      box-shadow: 0 0 0 0.2rem rgba(251, 191, 36, 0.15);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
    }
    .btn {
      border-radius: 10px;
      font-weight: 600;
      padding: 0.55rem 1rem;
    }
    .btn-outline-secondary {
      color: var(--text);
      border-color: rgba(148, 163, 184, 0.4);
      background: transparent;
    }
    .btn-outline-secondary:hover {
      border-color: rgba(251, 191, 36, 0.6);
      color: var(--accent);
      background: rgba(251, 191, 36, 0.08);
    }
    .btn-success {
      background: linear-gradient(135deg, rgba(52, 211, 153, 0.9), rgba(16, 185, 129, 0.9));
      border: none;
      color: #082f1d;
    }
    .btn-success:hover { filter: brightness(1.05); }
    .user-list {
      max-height: 380px;
      overflow-y: auto;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.6);
    }
    .user-list-item {
      cursor: pointer;
      padding: 0.6rem 1rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.12);
      color: var(--text);
      transition: all 0.2s ease;
    }
    .user-list-item:hover {
      background: rgba(148, 163, 184, 0.12);
    }
    .user-list-item.selected {
      background: rgba(251, 191, 36, 0.15);
      color: var(--accent);
      font-weight: 600;
    }
    .edit-form label {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
    }
    .form-check-label { color: var(--text); }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem 1rem;
    }
    .form-grid .mb-2 { margin-bottom: 0; }
    .divider {
      height: 1px;
      background: rgba(148, 163, 184, 0.2);
      margin: 1.5rem 0;
    }
    .tip-row {
      padding: 1rem 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }
    .tip-row:last-child { border-bottom: none; }
    .tip-row strong { color: var(--text); }
    .tip-card {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .tip-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
      align-items: center;
      justify-content: space-between;
    }
    .tip-meta {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .tip-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 0.75rem;
      align-items: center;
    }
    .points-display {
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.2);
      font-size: 0.85rem;
      color: var(--muted);
    }
    .points-display.positive {
      color: #86efac;
      border-color: rgba(52, 211, 153, 0.4);
      background: rgba(16, 185, 129, 0.15);
    }
    .save-status {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .save-status.saving { color: #fcd34d; }
    .save-status.success { color: #86efac; }
    .save-status.error { color: #fca5a5; }
    .user-save-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }
    .save-tip-btn {
      border-color: rgba(59, 130, 246, 0.4);
      color: #bfdbfe;
    }
    .save-tip-btn:hover {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.6);
      color: #dbeafe;
    }
    @keyframes float-in {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 991px) {
      .page { padding-top: 2rem; }
      .panel { padding: 1.25rem; }
      .tip-header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="page-header">
    <a href="admin-dark.html" class="back-link">&larr; Back to Admin</a>
    <div>
      <p class="eyebrow">Admin Console</p>
      <h1 class="page-title">User Admin</h1>
      <p class="subtitle">Review payments, edit profiles, and manage tips without leaving the dashboard.</p>
    </div>
  </header>

  <section class="panel stat-card">
    <div class="stat-title">Fees Collected</div>
    <div id="fees-collected-counter" class="stat-value">$0</div>
    <div class="stat-caption">$30 per paid entry</div>
  </section>

  <section class="panel toolbar">
    <div class="search-row">
      <input type="text" id="user-search" class="form-control" placeholder="Search users by name, email, or team name...">
      <div class="toolbar-actions">
        <button class="btn btn-outline-secondary" id="export-csv">Export CSV</button>
        <button class="btn btn-outline-secondary" id="export-ladder-csv">Export Ladder</button>
      </div>
    </div>
  </section>

  <div class="row g-4">
    <div class="col-lg-4">
      <section class="panel">
        <div class="panel-header">
          <h5>Paid Players</h5>
          <span class="panel-hint">Select a player to edit their details.</span>
        </div>
        <div class="user-list" id="user-list"></div>
      </section>
      <section class="panel mt-4">
        <div class="panel-header">
          <h5>Unpaid Players</h5>
          <span class="panel-hint">Not included in the leaderboard.</span>
        </div>
        <div class="user-list" id="unpaid-user-list"></div>
      </section>
    </div>
    <div class="col-lg-8">
      <section id="user-edit-section" class="panel user-edit-section" style="display:none;">
        <div class="panel-header">
          <h4>Edit User</h4>
          <span class="panel-hint">Save changes when you are ready.</span>
        </div>
        <form id="user-edit-form" class="edit-form">
          <div class="form-grid">
            <div class="mb-2">
              <label>Email:</label>
              <input type="email" class="form-control" id="edit-email" required>
            </div>
            <div class="mb-2">
              <label>Team Name:</label>
              <input type="text" class="form-control" id="edit-teamName">
            </div>
            <div class="mb-2">
              <label>First Name:</label>
              <input type="text" class="form-control" id="edit-firstName">
            </div>
            <div class="mb-2">
              <label>Last Name:</label>
              <input type="text" class="form-control" id="edit-lastName">
            </div>
            <div class="mb-2">
              <label>Jokers:</label>
              <input type="number" class="form-control" id="edit-joker" min="0">
            </div>
            <div class="mb-2">
              <label class="form-check-label" for="edit-paid">Paid</label>
              <div>
                <input type="checkbox" class="form-check-input" id="edit-paid">
              </div>
            </div>
          </div>
          <div class="user-save-row mt-3">
            <button type="submit" class="btn btn-success" id="save-user-btn">Save User</button>
            <span id="user-save-status" class="save-status"></span>
          </div>
        </form>
        <div class="divider"></div>
        <div class="panel-header">
          <h5>User Tips</h5>
          <span class="panel-hint">Update picks and joker status per race.</span>
        </div>
        <div id="user-tips-list"></div>
      </section>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, updateDoc, getDoc, setDoc, query, where
} from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrgNrA4n62hg1U3ujZMRCOYcbLcwT77ZA",
  authDomain: "tmstipping.firebaseapp.com",
  projectId: "tmstipping",
  storageBucket: "tmstipping.appspot.com",
  messagingSenderId: "401677933527",
  appId: "1:401677933527:web:2312ad4ef69aef6551c992",
  measurementId: "G-GXLRCHV687"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const rtdb = getDatabase(app);

let users = [];
let selectedUserId = null;
let selectedUserData = null;
let races = {};
let resultsCache = {};
let resultsLoaded = false;
let tipsByRace = {};

const userListDiv = document.getElementById('user-list');
const unpaidUserListDiv = document.getElementById('unpaid-user-list');
const searchInput = document.getElementById('user-search');
const feesCounter = document.getElementById('fees-collected-counter');
const userSaveStatus = document.getElementById('user-save-status');
const saveUserBtn = document.getElementById('save-user-btn');

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("You must be logged in.");
    window.location.href = "index.html";
    return;
  }
  // Simple Realtime DB admin gate
  const adminRef = ref(rtdb, `users/${user.uid}/admin`);
  const snapshot = await get(adminRef);
  if (!snapshot.exists() || snapshot.val() !== true) {
    alert("You are not authorized to access this page.");
    window.location.href = "index.html";
    return;
  }
  await loadRaces();
  await loadUsers();
});

/* -------------------------------
   Data loading
--------------------------------*/
async function loadRaces() {
  races = {};
  const racesSnap = await getDocs(collection(db, "races"));
  racesSnap.forEach(docSnap => {
    races[docSnap.id] = docSnap.data();
  });
}

async function loadResultsCache() {
  if (resultsLoaded) return;
  resultsCache = {};
  const resultsSnap = await getDocs(collection(db, "results"));
  resultsSnap.forEach(docSnap => {
    resultsCache[docSnap.id] = docSnap.data();
  });
  resultsLoaded = true;
}

function updateFeesCounter() {
  const paidCount = users.filter(u => u.paid === true).length;
  feesCounter.textContent = `$${paidCount * 30}`;
}

async function loadUsers() {
  userListDiv.innerHTML = '<div class="text-muted p-2">Loading users...</div>';
  unpaidUserListDiv.innerHTML = '<div class="text-muted p-2">Loading users...</div>';

  const usersSnap = await getDocs(collection(db, "users"));
  users = [];

  usersSnap.forEach(docSnap => {
    const userData = docSnap.data();
    users.push({ id: docSnap.id, ...userData });
  });

  // Update fees collected counter ($30 per paid)
  updateFeesCounter();

  filterAndRenderLists();
}

/* -------------------------------
   Rendering helpers
--------------------------------*/
function renderUserList(userArr, container) {
  container.innerHTML = '';
  if (userArr.length === 0) {
    container.innerHTML = '<div class="text-muted p-2">No users found.</div>';
    return;
  }
  userArr.forEach(user => {
    const div = document.createElement('div');
    div.className = 'user-list-item' + (user.id === selectedUserId ? ' selected' : '');
    const name = `${user.firstName || ''} ${user.lastName || ''}`.trim();
    div.textContent = `${user.teamName || ''} (${name}) - ${user.email || ''}`;
    div.onclick = () => selectUser(user.id);
    container.appendChild(div);
  });
}

function filterAndRenderLists() {
  const q = (searchInput.value || '').trim().toLowerCase();

  const matches = (u) =>
    ((u.email && u.email.toLowerCase().includes(q)) ||
     (u.firstName && u.firstName.toLowerCase().includes(q)) ||
     (u.lastName && u.lastName.toLowerCase().includes(q)) ||
     (u.teamName && u.teamName.toLowerCase().includes(q)));

  const paidFiltered = users.filter(u => u.paid === true && matches(u));
  const unpaidFiltered = users.filter(u => u.paid !== true && matches(u));

  renderUserList(paidFiltered, userListDiv);
  renderUserList(unpaidFiltered, unpaidUserListDiv);
}

searchInput.oninput = filterAndRenderLists;

/* -------------------------------
   Select & edit user
--------------------------------*/
async function selectUser(userId) {
  selectedUserId = userId;
  selectedUserData = null;
  // re-apply filters to refresh selected highlight
  filterAndRenderLists();

  document.getElementById('user-edit-section').style.display = '';
  userSaveStatus.textContent = '';
  userSaveStatus.className = 'save-status';
  saveUserBtn.disabled = false;

  const userDoc = await getDoc(doc(db, "users", userId));
  const user = userDoc.exists() ? userDoc.data() : {};
  selectedUserData = { id: userId, ...user };

  document.getElementById('edit-email').value = user.email || '';
  document.getElementById('edit-firstName').value = user.firstName || '';
  document.getElementById('edit-lastName').value = user.lastName || '';
  document.getElementById('edit-teamName').value = user.teamName || '';
  document.getElementById('edit-joker').value =
    typeof user.joker === "number" ? user.joker : (user.joker ? Number(user.joker) : 0);
  document.getElementById('edit-paid').checked = !!user.paid;

  await loadUserTips(userId);
}

document.getElementById('user-edit-form').onsubmit = async function(e) {
  e.preventDefault();
  if (!selectedUserId) return;

  const email = document.getElementById('edit-email').value;
  const firstName = document.getElementById('edit-firstName').value;
  const lastName = document.getElementById('edit-lastName').value;
  const teamName = document.getElementById('edit-teamName').value;
  const paid = document.getElementById('edit-paid').checked;
  const joker = Number(document.getElementById('edit-joker').value) || 0;

  saveUserBtn.disabled = true;
  userSaveStatus.textContent = 'Saving...';
  userSaveStatus.className = 'save-status saving';

  try {
    await updateDoc(doc(db, "users", selectedUserId), {
      email, firstName, lastName, teamName, paid, joker
    });

    // keep leaderboard doc's teamName aligned if it exists
    const leaderboardDocRef = doc(db, "leaderboard", selectedUserId);
    const leaderboardDoc = await getDoc(leaderboardDocRef);
    if (leaderboardDoc.exists()) {
      await updateDoc(leaderboardDocRef, { teamName });
    }

    const idx = users.findIndex(u => u.id === selectedUserId);
    if (idx !== -1) {
      users[idx] = { ...users[idx], email, firstName, lastName, teamName, paid, joker };
    }
    selectedUserData = { id: selectedUserId, email, firstName, lastName, teamName, paid, joker };
    updateFeesCounter();
    filterAndRenderLists();
    userSaveStatus.textContent = 'Saved';
    userSaveStatus.className = 'save-status success';
  } catch (err) {
    console.error(err);
    userSaveStatus.textContent = 'Error saving';
    userSaveStatus.className = 'save-status error';
  } finally {
    saveUserBtn.disabled = false;
    setTimeout(() => {
      if (userSaveStatus.textContent === 'Saved') userSaveStatus.textContent = '';
    }, 2000);
  }
};

/* -------------------------------
   Tips view & save (with points calc)
--------------------------------*/
async function loadUserTips(userId) {
  const tipsDiv = document.getElementById('user-tips-list');
  tipsDiv.innerHTML = 'Loading tips...';

  await loadResultsCache();

  const tipsSnap = await getDocs(query(collection(db, "tips"), where("userId", "==", userId)));
  tipsByRace = {};
  tipsSnap.forEach(docSnap => {
    const data = docSnap.data();
    tipsByRace[data.raceId] = { id: docSnap.id, ...data };
  });

  const allRaceIds = Object.keys(races);
  allRaceIds.sort((a, b) => {
    const aDate = new Date(`${races[a].date}T${races[a].time}`);
    const bDate = new Date(`${races[b].date}T${races[b].time}`);
    return aDate - bDate;
  });

  tipsDiv.innerHTML = '';

  for (const raceId of allRaceIds) {
    const race = races[raceId];
    const tip = tipsByRace[raceId];
    const horseId = tip ? tip.horseId : '';
    const jokerUsed = tip ? tip.joker === true : false;
    const points = calculatePoints(raceId, horseId, jokerUsed);

    const row = document.createElement('div');
    row.className = 'tip-row';
    row.dataset.raceRow = raceId;
    row.innerHTML = `
      <div class="tip-card">
        <div class="tip-header">
          <div>
            <strong>${race.name}</strong>
            <div class="tip-meta">${race.date} ${race.time}</div>
          </div>
          <span class="points-display ${points > 0 ? 'positive' : ''}" data-points-for="${raceId}">
            ${points > 0 ? `Points: ${points}` : 'No points'}
          </span>
        </div>
        <div class="tip-controls">
          <select class="form-select form-select-sm" style="width:auto;max-width:240px;" data-race-id="${raceId}">
            <option value="">No Tip</option>
            ${Object.entries(race.horses || {})
              .filter(([_, h]) => !h.scratched)
              .sort((a, b) => (a[1].number || 0) - (b[1].number || 0))
              .map(([hId, h]) =>
                `<option value="${hId}" ${hId === horseId ? 'selected' : ''}>#${h.number} ${h.name}</option>`
              ).join('')}
          </select>
          <label>
            <input type="checkbox" class="form-check-input joker-checkbox" data-race-id="${raceId}" ${jokerUsed ? 'checked' : ''}>
            Joker
          </label>
          <button class="btn btn-sm btn-outline-primary save-tip-btn" data-race-id="${raceId}">Save</button>
          <span class="save-status" data-status-for="${raceId}"></span>
        </div>
      </div>
    `;
    tipsDiv.appendChild(row);
  }

  tipsDiv.onchange = async function(e) {
    const target = e.target;
    if (target.matches('select[data-race-id], .joker-checkbox[data-race-id]')) {
      const raceId = target.dataset.raceId;
      await saveTipForRace(raceId);
    }
  };

  tipsDiv.onclick = async function(e) {
    const btn = e.target.closest('.save-tip-btn');
    if (!btn) return;
    const raceId = btn.dataset.raceId;
    await saveTipForRace(raceId);
  };
}

function calculatePoints(raceId, horseId, jokerUsed) {
  let points = 0;
  let matched = false;
  const results = resultsCache[raceId] || null;
  if (results && horseId) {
    if (results.winningHorseId === horseId) {
      points += Number(results.points) || 0; matched = true;
    }
    if (results.place1HorseId === horseId) {
      points += Number(results.place1Points) || 0; matched = true;
    }
    if (results.place2HorseId === horseId) {
      points += Number(results.place2Points) || 0; matched = true;
    }
    if (matched && jokerUsed && points > 0) {
      points *= 2;
    }
  }
  return points;
}

async function saveTipForRace(raceId) {
  if (!raceId || !selectedUserId) return;
  const tipsDiv = document.getElementById('user-tips-list');
  const row = tipsDiv.querySelector(`[data-race-row="${raceId}"]`);
  if (!row) return;
  const select = row.querySelector(`select[data-race-id="${raceId}"]`);
  const jokerCheckbox = row.querySelector(`.joker-checkbox[data-race-id="${raceId}"]`);
  const status = row.querySelector(`[data-status-for="${raceId}"]`);
  const pointsEl = row.querySelector(`[data-points-for="${raceId}"]`);

  const chosenHorseId = select ? select.value : '';
  const joker = jokerCheckbox ? jokerCheckbox.checked : false;

  status.textContent = 'Saving...';
  status.className = 'save-status saving';

  const tipDocId = `${selectedUserId}_${raceId}`;
  try {
    await setDoc(doc(db, "tips", tipDocId), {
      userId: selectedUserId,
      raceId,
      horseId: chosenHorseId || "",
      timestamp: Date.now(),
      joker
    });

    tipsByRace[raceId] = { userId: selectedUserId, raceId, horseId: chosenHorseId || "", joker };
    await recalculateLeaderboardForUser(selectedUserId, tipsByRace);

    const points = calculatePoints(raceId, chosenHorseId, joker);
    if (pointsEl) {
      pointsEl.textContent = points > 0 ? `Points: ${points}` : 'No points';
      pointsEl.classList.toggle('positive', points > 0);
    }
    status.textContent = 'Saved';
    status.className = 'save-status success';
    setTimeout(() => {
      if (status.textContent === 'Saved') status.textContent = '';
    }, 1500);
  } catch (err) {
    console.error(err);
    status.textContent = 'Error';
    status.className = 'save-status error';
  }
}

/* -------------------------------
   Leaderboard recalculation (per user)
--------------------------------*/
async function recalculateLeaderboardForUser(userId, tipsMap = null) {
  // ensure races and results are available
  if (!races || !Object.keys(races).length) await loadRaces();
  await loadResultsCache();

  const tipsSource = tipsMap || tipsByRace;
  let totalPoints = 0;

  for (const raceId of Object.keys(races)) {
    const userTip = tipsSource[raceId];
    if (!userTip || !userTip.horseId) continue;
    const pts = calculatePoints(raceId, userTip.horseId, !!userTip.joker);
    totalPoints += pts;
  }

  const user = selectedUserData && selectedUserData.id === userId ? selectedUserData : null;
  if (!user) {
    const userDoc = await getDoc(doc(db, "users", userId));
    selectedUserData = userDoc.exists() ? { id: userId, ...userDoc.data() } : { id: userId };
  }

  await setDoc(doc(db, "leaderboard", userId), {
    userId,
    teamName: (selectedUserData && selectedUserData.teamName) || userId,
    points: totalPoints
  }, { merge: true });
}

/* -------------------------------
   Exports
--------------------------------*/
document.getElementById('export-csv').onclick = function() {
  if (!users.length) return;
  const header = ['UserID', 'Email', 'First Name', 'Last Name', 'Team Name', 'Paid'];
  const rows = users.map(u => [
    `"${u.id}"`,
    `"${u.email || ''}"`,
    `"${u.firstName || ''}"`,
    `"${u.lastName || ''}"`,
    `"${u.teamName || ''}"`,
    u.paid === true ? 'true' : 'false'
  ]);
  const csv = header.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'users.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

document.getElementById('export-ladder-csv').onclick = async function() {
  const snapshot = await getDocs(collection(db, "leaderboard"));
  const leaderboard = [];
  snapshot.forEach(docSnap => {
    leaderboard.push({ id: docSnap.id, ...docSnap.data() });
  });
  leaderboard.sort((a, b) => (Number(b.points || 0) - Number(a.points || 0)));

  const header = ['Rank', 'Team Name', 'Points'];
  const rows = leaderboard.map((entry, idx) => [
    idx + 1,
    `"${entry.teamName || entry.userId || entry.id}"`,
    Number(entry.points || 0)
  ]);
  const csv = header.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ladder.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
